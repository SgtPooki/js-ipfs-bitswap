(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.IpfsBitswap = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var IpfsBitswap=(()=>{var vs=Object.create;var Wt=Object.defineProperty;var xs=Object.getOwnPropertyDescriptor;var ks=Object.getOwnPropertyNames;var Ss=Object.getPrototypeOf,Es=Object.prototype.hasOwnProperty;var v=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports),N=(r,t)=>{for(var e in t)Wt(r,e,{get:t[e],enumerable:!0})},Tr=(r,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ks(t))!Es.call(r,i)&&i!==e&&Wt(r,i,{get:()=>t[i],enumerable:!(n=xs(t,i))||n.enumerable});return r};var L=(r,t,e)=>(e=r!=null?vs(Ss(r)):{},Tr(t||!r||!r.__esModule?Wt(e,"default",{value:r,enumerable:!0}):e,r)),Cs=r=>Tr(Wt({},"__esModule",{value:!0}),r);var Xr=v(($c,Qr)=>{Qr.exports=jr;var Gr=128,ho=127,fo=~ho,po=Math.pow(2,31);function jr(r,t,e){t=t||[],e=e||0;for(var n=e;r>=po;)t[e++]=r&255|Gr,r/=128;for(;r&fo;)t[e++]=r&255|Gr,r>>>=7;return t[e]=r|0,jr.bytes=e-n+1,t}});var Zr=v((Gc,Kr)=>{Kr.exports=Oe;var go=128,Jr=127;function Oe(r,n){var e=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Oe.bytes=0,new RangeError("Could not decode varint");o=r[s++],e+=i<28?(o&Jr)<<i:(o&Jr)*Math.pow(2,i),i+=7}while(o>=go);return Oe.bytes=s-n,e}});var tn=v((jc,Yr)=>{var mo=Math.pow(2,7),yo=Math.pow(2,14),bo=Math.pow(2,21),wo=Math.pow(2,28),_o=Math.pow(2,35),vo=Math.pow(2,42),xo=Math.pow(2,49),ko=Math.pow(2,56),So=Math.pow(2,63);Yr.exports=function(r){return r<mo?1:r<yo?2:r<bo?3:r<wo?4:r<_o?5:r<vo?6:r<xo?7:r<ko?8:r<So?9:10}});var rn=v((Qc,en)=>{en.exports={encode:Xr(),decode:Zr(),encodingLength:tn()}});var on=v((Xc,sn)=>{"use strict";var nn=rn();sn.exports=r=>{if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let t=[];for(;r.length>0;){let e=nn.decode(r);t.push(e),r=r.slice(nn.decode.bytes)}return t}});var un=v((Jc,cn)=>{cn.exports=Pe;var an=128,Eo=127,Co=~Eo,Ao=Math.pow(2,31);function Pe(r,t,e){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw Pe.bytes=0,new RangeError("Could not encode varint");t=t||[],e=e||0;for(var n=e;r>=Ao;)t[e++]=r&255|an,r/=128;for(;r&Co;)t[e++]=r&255|an,r>>>=7;return t[e]=r|0,Pe.bytes=e-n+1,t}});var fn=v((Kc,hn)=>{hn.exports=Ie;var Bo=128,ln=127;function Ie(r,n){var e=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a||i>49)throw Ie.bytes=0,new RangeError("Could not decode varint");o=r[s++],e+=i<28?(o&ln)<<i:(o&ln)*Math.pow(2,i),i+=7}while(o>=Bo);return Ie.bytes=s-n,e}});var pn=v((Zc,dn)=>{var To=Math.pow(2,7),Lo=Math.pow(2,14),Mo=Math.pow(2,21),Do=Math.pow(2,28),No=Math.pow(2,35),Fo=Math.pow(2,42),Oo=Math.pow(2,49),Po=Math.pow(2,56),Io=Math.pow(2,63);dn.exports=function(r){return r<To?1:r<Lo?2:r<Mo?3:r<Do?4:r<No?5:r<Fo?6:r<Oo?7:r<Po?8:r<Io?9:10}});var mn=v((Yc,gn)=>{gn.exports={encode:un(),decode:fn(),encodingLength:pn()}});var wn=v((eu,bn)=>{var vt=1e3,xt=vt*60,kt=xt*60,ot=kt*24,Ro=ot*7,Uo=ot*365.25;bn.exports=function(r,t){t=t||{};var e=typeof r;if(e==="string"&&r.length>0)return Ho(r);if(e==="number"&&isFinite(r))return t.long?Wo(r):qo(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function Ho(r){if(r=String(r),!(r.length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(t){var e=parseFloat(t[1]),n=(t[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return e*Uo;case"weeks":case"week":case"w":return e*Ro;case"days":case"day":case"d":return e*ot;case"hours":case"hour":case"hrs":case"hr":case"h":return e*kt;case"minutes":case"minute":case"mins":case"min":case"m":return e*xt;case"seconds":case"second":case"secs":case"sec":case"s":return e*vt;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return e;default:return}}}}function qo(r){var t=Math.abs(r);return t>=ot?Math.round(r/ot)+"d":t>=kt?Math.round(r/kt)+"h":t>=xt?Math.round(r/xt)+"m":t>=vt?Math.round(r/vt)+"s":r+"ms"}function Wo(r){var t=Math.abs(r);return t>=ot?$t(r,t,ot,"day"):t>=kt?$t(r,t,kt,"hour"):t>=xt?$t(r,t,xt,"minute"):t>=vt?$t(r,t,vt,"second"):r+" ms"}function $t(r,t,e,n){var i=t>=e*1.5;return Math.round(r/e)+" "+n+(i?"s":"")}});var vn=v((ru,_n)=>{function Vo(r){e.debug=e,e.default=e,e.coerce=c,e.disable=s,e.enable=i,e.enabled=o,e.humanize=wn(),e.destroy=u,Object.keys(r).forEach(l=>{e[l]=r[l]}),e.names=[],e.skips=[],e.formatters={};function t(l){let h=0;for(let f=0;f<l.length;f++)h=(h<<5)-h+l.charCodeAt(f),h|=0;return e.colors[Math.abs(h)%e.colors.length]}e.selectColor=t;function e(l){let h,f=null,m,d;function p(...y){if(!p.enabled)return;let S=p,A=Number(new Date),P=A-(h||A);S.diff=P,S.prev=h,S.curr=A,h=A,y[0]=e.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let T=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(I,D)=>{if(I==="%%")return"%";T++;let z=e.formatters[D];if(typeof z=="function"){let mt=y[T];I=z.call(S,mt),y.splice(T,1),T--}return I}),e.formatArgs.call(S,y),(S.log||e.log).apply(S,y)}return p.namespace=l,p.useColors=e.useColors(),p.color=e.selectColor(l),p.extend=n,p.destroy=e.destroy,Object.defineProperty(p,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(m!==e.namespaces&&(m=e.namespaces,d=e.enabled(l)),d),set:y=>{f=y}}),typeof e.init=="function"&&e.init(p),p}function n(l,h){let f=e(this.namespace+(typeof h>"u"?":":h)+l);return f.log=this.log,f}function i(l){e.save(l),e.namespaces=l,e.names=[],e.skips=[];let h,f=(typeof l=="string"?l:"").split(/[\s,]+/),m=f.length;for(h=0;h<m;h++)f[h]&&(l=f[h].replace(/\*/g,".*?"),l[0]==="-"?e.skips.push(new RegExp("^"+l.slice(1)+"$")):e.names.push(new RegExp("^"+l+"$")))}function s(){let l=[...e.names.map(a),...e.skips.map(a).map(h=>"-"+h)].join(",");return e.enable(""),l}function o(l){if(l[l.length-1]==="*")return!0;let h,f;for(h=0,f=e.skips.length;h<f;h++)if(e.skips[h].test(l))return!1;for(h=0,f=e.names.length;h<f;h++)if(e.names[h].test(l))return!0;return!1}function a(l){return l.toString().substring(2,l.toString().length-2).replace(/\.\*\?$/,"*")}function c(l){return l instanceof Error?l.stack||l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.enable(e.load()),e}_n.exports=Vo});var xn=v((F,Gt)=>{F.formatArgs=Go;F.save=jo;F.load=Qo;F.useColors=$o;F.storage=Xo();F.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();F.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function $o(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Go(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Gt.exports.humanize(this.diff),!this.useColors)return;let t="color: "+this.color;r.splice(1,0,t,"color: inherit");let e=0,n=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(e++,i==="%c"&&(n=e))}),r.splice(n,0,t)}F.log=console.debug||console.log||(()=>{});function jo(r){try{r?F.storage.setItem("debug",r):F.storage.removeItem("debug")}catch{}}function Qo(){let r;try{r=F.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function Xo(){try{return localStorage}catch{}}Gt.exports=vn()(F);var{formatters:Jo}=Gt.exports;Jo.j=function(r){try{return JSON.stringify(r)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}});var En=v((bu,Sn)=>{"use strict";Sn.exports=ea;function ea(r,t){for(var e=new Array(arguments.length-1),n=0,i=2,s=!0;i<arguments.length;)e[n++]=arguments[i++];return new Promise(function(a,c){e[n]=function(l){if(s)if(s=!1,l)c(l);else{for(var h=new Array(arguments.length-1),f=0;f<h.length;)h[f++]=arguments[f];a.apply(null,h)}};try{r.apply(t||null,e)}catch(u){s&&(s=!1,c(u))}})}});var Tn=v(Bn=>{"use strict";var Xt=Bn;Xt.length=function(t){var e=t.length;if(!e)return 0;for(var n=0;--e%4>1&&t.charAt(e)==="=";)++n;return Math.ceil(t.length*3)/4-n};var St=new Array(64),An=new Array(123);for(W=0;W<64;)An[St[W]=W<26?W+65:W<52?W+71:W<62?W-4:W-59|43]=W++;var W;Xt.encode=function(t,e,n){for(var i=null,s=[],o=0,a=0,c;e<n;){var u=t[e++];switch(a){case 0:s[o++]=St[u>>2],c=(u&3)<<4,a=1;break;case 1:s[o++]=St[c|u>>4],c=(u&15)<<2,a=2;break;case 2:s[o++]=St[c|u>>6],s[o++]=St[u&63],a=0;break}o>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,s)),o=0)}return a&&(s[o++]=St[c],s[o++]=61,a===1&&(s[o++]=61)),i?(o&&i.push(String.fromCharCode.apply(String,s.slice(0,o))),i.join("")):String.fromCharCode.apply(String,s.slice(0,o))};var Cn="invalid encoding";Xt.decode=function(t,e,n){for(var i=n,s=0,o,a=0;a<t.length;){var c=t.charCodeAt(a++);if(c===61&&s>1)break;if((c=An[c])===void 0)throw Error(Cn);switch(s){case 0:o=c,s=1;break;case 1:e[n++]=o<<2|(c&48)>>4,o=c,s=2;break;case 2:e[n++]=(o&15)<<4|(c&60)>>2,o=c,s=3;break;case 3:e[n++]=(o&3)<<6|c,s=0;break}}if(s===1)throw Error(Cn);return n-i};Xt.test=function(t){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(t)}});var Mn=v((_u,Ln)=>{"use strict";Ln.exports=Jt;function Jt(){this._listeners={}}Jt.prototype.on=function(t,e,n){return(this._listeners[t]||(this._listeners[t]=[])).push({fn:e,ctx:n||this}),this};Jt.prototype.off=function(t,e){if(t===void 0)this._listeners={};else if(e===void 0)this._listeners[t]=[];else for(var n=this._listeners[t],i=0;i<n.length;)n[i].fn===e?n.splice(i,1):++i;return this};Jt.prototype.emit=function(t){var e=this._listeners[t];if(e){for(var n=[],i=1;i<arguments.length;)n.push(arguments[i++]);for(i=0;i<e.length;)e[i].fn.apply(e[i++].ctx,n)}return this}});var zn=v((vu,In)=>{"use strict";In.exports=Dn(Dn);function Dn(r){return typeof Float32Array<"u"?function(){var t=new Float32Array([-0]),e=new Uint8Array(t.buffer),n=e[3]===128;function i(c,u,l){t[0]=c,u[l]=e[0],u[l+1]=e[1],u[l+2]=e[2],u[l+3]=e[3]}function s(c,u,l){t[0]=c,u[l]=e[3],u[l+1]=e[2],u[l+2]=e[1],u[l+3]=e[0]}r.writeFloatLE=n?i:s,r.writeFloatBE=n?s:i;function o(c,u){return e[0]=c[u],e[1]=c[u+1],e[2]=c[u+2],e[3]=c[u+3],t[0]}function a(c,u){return e[3]=c[u],e[2]=c[u+1],e[1]=c[u+2],e[0]=c[u+3],t[0]}r.readFloatLE=n?o:a,r.readFloatBE=n?a:o}():function(){function t(n,i,s,o){var a=i<0?1:0;if(a&&(i=-i),i===0)n(1/i>0?0:2147483648,s,o);else if(isNaN(i))n(2143289344,s,o);else if(i>34028234663852886e22)n((a<<31|2139095040)>>>0,s,o);else if(i<11754943508222875e-54)n((a<<31|Math.round(i/1401298464324817e-60))>>>0,s,o);else{var c=Math.floor(Math.log(i)/Math.LN2),u=Math.round(i*Math.pow(2,-c)*8388608)&8388607;n((a<<31|c+127<<23|u)>>>0,s,o)}}r.writeFloatLE=t.bind(null,Nn),r.writeFloatBE=t.bind(null,Fn);function e(n,i,s){var o=n(i,s),a=(o>>31)*2+1,c=o>>>23&255,u=o&8388607;return c===255?u?NaN:a*(1/0):c===0?a*1401298464324817e-60*u:a*Math.pow(2,c-150)*(u+8388608)}r.readFloatLE=e.bind(null,On),r.readFloatBE=e.bind(null,Pn)}(),typeof Float64Array<"u"?function(){var t=new Float64Array([-0]),e=new Uint8Array(t.buffer),n=e[7]===128;function i(c,u,l){t[0]=c,u[l]=e[0],u[l+1]=e[1],u[l+2]=e[2],u[l+3]=e[3],u[l+4]=e[4],u[l+5]=e[5],u[l+6]=e[6],u[l+7]=e[7]}function s(c,u,l){t[0]=c,u[l]=e[7],u[l+1]=e[6],u[l+2]=e[5],u[l+3]=e[4],u[l+4]=e[3],u[l+5]=e[2],u[l+6]=e[1],u[l+7]=e[0]}r.writeDoubleLE=n?i:s,r.writeDoubleBE=n?s:i;function o(c,u){return e[0]=c[u],e[1]=c[u+1],e[2]=c[u+2],e[3]=c[u+3],e[4]=c[u+4],e[5]=c[u+5],e[6]=c[u+6],e[7]=c[u+7],t[0]}function a(c,u){return e[7]=c[u],e[6]=c[u+1],e[5]=c[u+2],e[4]=c[u+3],e[3]=c[u+4],e[2]=c[u+5],e[1]=c[u+6],e[0]=c[u+7],t[0]}r.readDoubleLE=n?o:a,r.readDoubleBE=n?a:o}():function(){function t(n,i,s,o,a,c){var u=o<0?1:0;if(u&&(o=-o),o===0)n(0,a,c+i),n(1/o>0?0:2147483648,a,c+s);else if(isNaN(o))n(0,a,c+i),n(2146959360,a,c+s);else if(o>17976931348623157e292)n(0,a,c+i),n((u<<31|2146435072)>>>0,a,c+s);else{var l;if(o<22250738585072014e-324)l=o/5e-324,n(l>>>0,a,c+i),n((u<<31|l/4294967296)>>>0,a,c+s);else{var h=Math.floor(Math.log(o)/Math.LN2);h===1024&&(h=1023),l=o*Math.pow(2,-h),n(l*4503599627370496>>>0,a,c+i),n((u<<31|h+1023<<20|l*1048576&1048575)>>>0,a,c+s)}}}r.writeDoubleLE=t.bind(null,Nn,0,4),r.writeDoubleBE=t.bind(null,Fn,4,0);function e(n,i,s,o,a){var c=n(o,a+i),u=n(o,a+s),l=(u>>31)*2+1,h=u>>>20&2047,f=4294967296*(u&1048575)+c;return h===2047?f?NaN:l*(1/0):h===0?l*5e-324*f:l*Math.pow(2,h-1075)*(f+4503599627370496)}r.readDoubleLE=e.bind(null,On,0,4),r.readDoubleBE=e.bind(null,Pn,4,0)}(),r}function Nn(r,t,e){t[e]=r&255,t[e+1]=r>>>8&255,t[e+2]=r>>>16&255,t[e+3]=r>>>24}function Fn(r,t,e){t[e]=r>>>24,t[e+1]=r>>>16&255,t[e+2]=r>>>8&255,t[e+3]=r&255}function On(r,t){return(r[t]|r[t+1]<<8|r[t+2]<<16|r[t+3]<<24)>>>0}function Pn(r,t){return(r[t]<<24|r[t+1]<<16|r[t+2]<<8|r[t+3])>>>0}});var Rn=v((exports,module)=>{"use strict";module.exports=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(r){}return null}});var Hn=v(Un=>{"use strict";var Ue=Un;Ue.length=function(t){for(var e=0,n=0,i=0;i<t.length;++i)n=t.charCodeAt(i),n<128?e+=1:n<2048?e+=2:(n&64512)===55296&&(t.charCodeAt(i+1)&64512)===56320?(++i,e+=4):e+=3;return e};Ue.read=function(t,e,n){var i=n-e;if(i<1)return"";for(var s=null,o=[],a=0,c;e<n;)c=t[e++],c<128?o[a++]=c:c>191&&c<224?o[a++]=(c&31)<<6|t[e++]&63:c>239&&c<365?(c=((c&7)<<18|(t[e++]&63)<<12|(t[e++]&63)<<6|t[e++]&63)-65536,o[a++]=55296+(c>>10),o[a++]=56320+(c&1023)):o[a++]=(c&15)<<12|(t[e++]&63)<<6|t[e++]&63,a>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,o)),a=0);return s?(a&&s.push(String.fromCharCode.apply(String,o.slice(0,a))),s.join("")):String.fromCharCode.apply(String,o.slice(0,a))};Ue.write=function(t,e,n){for(var i=n,s,o,a=0;a<t.length;++a)s=t.charCodeAt(a),s<128?e[n++]=s:s<2048?(e[n++]=s>>6|192,e[n++]=s&63|128):(s&64512)===55296&&((o=t.charCodeAt(a+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++a,e[n++]=s>>18|240,e[n++]=s>>12&63|128,e[n++]=s>>6&63|128,e[n++]=s&63|128):(e[n++]=s>>12|224,e[n++]=s>>6&63|128,e[n++]=s&63|128);return n-i}});var Wn=v((ku,qn)=>{"use strict";qn.exports=ra;function ra(r,t,e){var n=e||8192,i=n>>>1,s=null,o=n;return function(c){if(c<1||c>i)return r(c);o+c>n&&(s=r(n),o=0);var u=t.call(s,o,o+=c);return o&7&&(o=(o|7)+1),u}}});var $n=v((Su,Vn)=>{"use strict";Vn.exports=B;var Ot=ut();function B(r,t){this.lo=r>>>0,this.hi=t>>>0}var ct=B.zero=new B(0,0);ct.toNumber=function(){return 0};ct.zzEncode=ct.zzDecode=function(){return this};ct.length=function(){return 1};var na=B.zeroHash="\0\0\0\0\0\0\0\0";B.fromNumber=function(t){if(t===0)return ct;var e=t<0;e&&(t=-t);var n=t>>>0,i=(t-n)/4294967296>>>0;return e&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new B(n,i)};B.from=function(t){if(typeof t=="number")return B.fromNumber(t);if(Ot.isString(t))if(Ot.Long)t=Ot.Long.fromString(t);else return B.fromNumber(parseInt(t,10));return t.low||t.high?new B(t.low>>>0,t.high>>>0):ct};B.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=~this.lo+1>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+n*4294967296)}return this.lo+this.hi*4294967296};B.prototype.toLong=function(t){return Ot.Long?new Ot.Long(this.lo|0,this.hi|0,!!t):{low:this.lo|0,high:this.hi|0,unsigned:!!t}};var rt=String.prototype.charCodeAt;B.fromHash=function(t){return t===na?ct:new B((rt.call(t,0)|rt.call(t,1)<<8|rt.call(t,2)<<16|rt.call(t,3)<<24)>>>0,(rt.call(t,4)|rt.call(t,5)<<8|rt.call(t,6)<<16|rt.call(t,7)<<24)>>>0)};B.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)};B.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this};B.prototype.zzDecode=function(){var t=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this};B.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?e===0?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10}});var ut=v(He=>{"use strict";var g=He;g.asPromise=En();g.base64=Tn();g.EventEmitter=Mn();g.float=zn();g.inquire=Rn();g.utf8=Hn();g.pool=Wn();g.LongBits=$n();g.isNode=!!(typeof globalThis<"u"&&globalThis&&globalThis.process&&globalThis.process.versions&&globalThis.process.versions.node);g.global=g.isNode&&globalThis||typeof window<"u"&&window||typeof self<"u"&&self||He;g.emptyArray=Object.freeze?Object.freeze([]):[];g.emptyObject=Object.freeze?Object.freeze({}):{};g.isInteger=Number.isInteger||function(t){return typeof t=="number"&&isFinite(t)&&Math.floor(t)===t};g.isString=function(t){return typeof t=="string"||t instanceof String};g.isObject=function(t){return t&&typeof t=="object"};g.isset=g.isSet=function(t,e){var n=t[e];return n!=null&&t.hasOwnProperty(e)?typeof n!="object"||(Array.isArray(n)?n.length:Object.keys(n).length)>0:!1};g.Buffer=function(){try{var r=g.inquire("buffer").Buffer;return r.prototype.utf8Write?r:null}catch{return null}}();g._Buffer_from=null;g._Buffer_allocUnsafe=null;g.newBuffer=function(t){return typeof t=="number"?g.Buffer?g._Buffer_allocUnsafe(t):new g.Array(t):g.Buffer?g._Buffer_from(t):typeof Uint8Array>"u"?t:new Uint8Array(t)};g.Array=typeof Uint8Array<"u"?Uint8Array:Array;g.Long=g.global.dcodeIO&&g.global.dcodeIO.Long||g.global.Long||g.inquire("long");g.key2Re=/^true|false|0|1$/;g.key32Re=/^-?(?:0|[1-9][0-9]*)$/;g.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/;g.longToHash=function(t){return t?g.LongBits.from(t).toHash():g.LongBits.zeroHash};g.longFromHash=function(t,e){var n=g.LongBits.fromHash(t);return g.Long?g.Long.fromBits(n.lo,n.hi,e):n.toNumber(!!e)};function Gn(r,t,e){for(var n=Object.keys(t),i=0;i<n.length;++i)(r[n[i]]===void 0||!e)&&(r[n[i]]=t[n[i]]);return r}g.merge=Gn;g.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)};function jn(r){function t(e,n){if(!(this instanceof t))return new t(e,n);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:new Error().stack||""}),n&&Gn(this,n)}return t.prototype=Object.create(Error.prototype,{constructor:{value:t,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return r},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),t}g.newError=jn;g.ProtocolError=jn("ProtocolError");g.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var i=Object.keys(this),s=i.length-1;s>-1;--s)if(e[i[s]]===1&&this[i[s]]!==void 0&&this[i[s]]!==null)return i[s]}};g.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}};g.toJSONOptions={longs:String,enums:String,bytes:String,json:!0};g._configure=function(){var r=g.Buffer;if(!r){g._Buffer_from=g._Buffer_allocUnsafe=null;return}g._Buffer_from=r.from!==Uint8Array.from&&r.from||function(e,n){return new r(e,n)},g._Buffer_allocUnsafe=r.allocUnsafe||function(e){return new r(e)}}});var Ve=v((Cu,Zn)=>{"use strict";Zn.exports=C;var j=ut(),We,Jn=j.LongBits,ia=j.utf8;function V(r,t){return RangeError("index out of range: "+r.pos+" + "+(t||1)+" > "+r.len)}function C(r){this.buf=r,this.pos=0,this.len=r.length}var Qn=typeof Uint8Array<"u"?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new C(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new C(t);throw Error("illegal buffer")},Kn=function(){return j.Buffer?function(e){return(C.create=function(i){return j.Buffer.isBuffer(i)?new We(i):Qn(i)})(e)}:Qn};C.create=Kn();C.prototype._slice=j.Array.prototype.subarray||j.Array.prototype.slice;C.prototype.uint32=function(){var t=4294967295;return function(){if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,V(this,10);return t}}();C.prototype.int32=function(){return this.uint32()|0};C.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(t&1)|0};function qe(){var r=new Jn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(r.lo=(r.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return r;if(r.lo=(r.lo|(this.buf[this.pos]&127)<<28)>>>0,r.hi=(r.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return r;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw V(this);if(r.lo=(r.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return r}return r.lo=(r.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,r}if(this.len-this.pos>4){for(;t<5;++t)if(r.hi=(r.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return r}else for(;t<5;++t){if(this.pos>=this.len)throw V(this);if(r.hi=(r.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return r}throw Error("invalid varint encoding")}C.prototype.bool=function(){return this.uint32()!==0};function Kt(r,t){return(r[t-4]|r[t-3]<<8|r[t-2]<<16|r[t-1]<<24)>>>0}C.prototype.fixed32=function(){if(this.pos+4>this.len)throw V(this,4);return Kt(this.buf,this.pos+=4)};C.prototype.sfixed32=function(){if(this.pos+4>this.len)throw V(this,4);return Kt(this.buf,this.pos+=4)|0};function Xn(){if(this.pos+8>this.len)throw V(this,8);return new Jn(Kt(this.buf,this.pos+=4),Kt(this.buf,this.pos+=4))}C.prototype.float=function(){if(this.pos+4>this.len)throw V(this,4);var t=j.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t};C.prototype.double=function(){if(this.pos+8>this.len)throw V(this,4);var t=j.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t};C.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw V(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)};C.prototype.string=function(){var t=this.bytes();return ia.read(t,0,t.length)};C.prototype.skip=function(t){if(typeof t=="number"){if(this.pos+t>this.len)throw V(this,t);this.pos+=t}else do if(this.pos>=this.len)throw V(this);while(this.buf[this.pos++]&128);return this};C.prototype.skipType=function(r){switch(r){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(r=this.uint32()&7)!==4;)this.skipType(r);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+r+" at offset "+this.pos)}return this};C._configure=function(r){We=r,C.create=Kn(),We._configure();var t=j.Long?"toLong":"toNumber";j.merge(C.prototype,{int64:function(){return qe.call(this)[t](!1)},uint64:function(){return qe.call(this)[t](!0)},sint64:function(){return qe.call(this).zzDecode()[t](!1)},fixed64:function(){return Xn.call(this)[t](!0)},sfixed64:function(){return Xn.call(this)[t](!1)}})}});var ri=v((Au,ei)=>{"use strict";ei.exports=lt;var ti=Ve();(lt.prototype=Object.create(ti.prototype)).constructor=lt;var Yn=ut();function lt(r){ti.call(this,r)}lt._configure=function(){Yn.Buffer&&(lt.prototype._slice=Yn.Buffer.prototype.slice)};lt.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))};lt._configure()});var Ke=v((Bu,oi)=>{"use strict";oi.exports=_;var H=ut(),$e,Zt=H.LongBits,ni=H.base64,ii=H.utf8;function Pt(r,t,e){this.fn=r,this.len=t,this.next=void 0,this.val=e}function je(){}function sa(r){this.head=r.head,this.tail=r.tail,this.len=r.len,this.next=r.states}function _(){this.len=0,this.head=new Pt(je,0,0),this.tail=this.head,this.states=null}var si=function(){return H.Buffer?function(){return(_.create=function(){return new $e})()}:function(){return new _}};_.create=si();_.alloc=function(t){return new H.Array(t)};H.Array!==Array&&(_.alloc=H.pool(_.alloc,H.Array.prototype.subarray));_.prototype._push=function(t,e,n){return this.tail=this.tail.next=new Pt(t,e,n),this.len+=e,this};function Qe(r,t,e){t[e]=r&255}function oa(r,t,e){for(;r>127;)t[e++]=r&127|128,r>>>=7;t[e]=r}function Xe(r,t){this.len=r,this.next=void 0,this.val=t}Xe.prototype=Object.create(Pt.prototype);Xe.prototype.fn=oa;_.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new Xe((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this};_.prototype.int32=function(t){return t<0?this._push(Je,10,Zt.fromNumber(t)):this.uint32(t)};_.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)};function Je(r,t,e){for(;r.hi;)t[e++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)t[e++]=r.lo&127|128,r.lo=r.lo>>>7;t[e++]=r.lo}_.prototype.uint64=function(t){var e=Zt.from(t);return this._push(Je,e.length(),e)};_.prototype.int64=_.prototype.uint64;_.prototype.sint64=function(t){var e=Zt.from(t).zzEncode();return this._push(Je,e.length(),e)};_.prototype.bool=function(t){return this._push(Qe,1,t?1:0)};function Ge(r,t,e){t[e]=r&255,t[e+1]=r>>>8&255,t[e+2]=r>>>16&255,t[e+3]=r>>>24}_.prototype.fixed32=function(t){return this._push(Ge,4,t>>>0)};_.prototype.sfixed32=_.prototype.fixed32;_.prototype.fixed64=function(t){var e=Zt.from(t);return this._push(Ge,4,e.lo)._push(Ge,4,e.hi)};_.prototype.sfixed64=_.prototype.fixed64;_.prototype.float=function(t){return this._push(H.float.writeFloatLE,4,t)};_.prototype.double=function(t){return this._push(H.float.writeDoubleLE,8,t)};var aa=H.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var i=0;i<t.length;++i)e[n+i]=t[i]};_.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(Qe,1,0);if(H.isString(t)){var n=_.alloc(e=ni.length(t));ni.decode(t,n,0),t=n}return this.uint32(e)._push(aa,e,t)};_.prototype.string=function(t){var e=ii.length(t);return e?this.uint32(e)._push(ii.write,e,t):this._push(Qe,1,0)};_.prototype.fork=function(){return this.states=new sa(this),this.head=this.tail=new Pt(je,0,0),this.len=0,this};_.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Pt(je,0,0),this.len=0),this};_.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this};_.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e};_._configure=function(r){$e=r,_.create=si(),$e._configure()}});var ui=v((Tu,ci)=>{"use strict";ci.exports=Q;var ai=Ke();(Q.prototype=Object.create(ai.prototype)).constructor=Q;var nt=ut();function Q(){ai.call(this)}Q._configure=function(){Q.alloc=nt._Buffer_allocUnsafe,Q.writeBytesBuffer=nt.Buffer&&nt.Buffer.prototype instanceof Uint8Array&&nt.Buffer.prototype.set.name==="set"?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var i=0;i<t.length;)e[n++]=t[i++]}};Q.prototype.bytes=function(t){nt.isString(t)&&(t=nt._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(Q.writeBytesBuffer,e,t),this};function ca(r,t,e){r.length<40?nt.utf8.write(r,t,e):t.utf8Write?t.utf8Write(r,e):t.write(r,e)}Q.prototype.string=function(t){var e=nt.Buffer.byteLength(t);return this.uint32(e),e&&this._push(ca,e,t),this};Q._configure()});var Ei=v(($l,Si)=>{"use strict";function ki(r,t){for(let e in t)Object.defineProperty(r,e,{value:t[e],enumerable:!0,configurable:!0});return r}function Sa(r,t,e){if(!r||typeof r=="string")throw new TypeError("Please pass an Error to err-code");e||(e={}),typeof t=="object"&&(e=t,t=""),t&&(e.code=t);try{return ki(r,e)}catch{e.message=r.message,e.stack=r.stack;let i=function(){};return i.prototype=Object.create(Object.getPrototypeOf(r)),ki(new i,e)}}Si.exports=Sa});var Di=v((uh,Mi)=>{"use strict";Mi.exports=function(){return Date.now()}});var Fi=v((lh,Ni)=>{"use strict";var he=Di(),lr=class{constructor(t,e,n){let i=this;this._started=he(),this._rescheduled=0,this._scheduled=e,this._args=n,this._triggered=!1,this._timerWrapper=()=>{i._rescheduled>0?(i._scheduled=i._rescheduled-(he()-i._started),i._schedule(i._scheduled)):(i._triggered=!0,t.apply(null,i._args))},this._timer=setTimeout(this._timerWrapper,e)}reschedule(t){t||(t=this._scheduled);let e=he();e+t-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(t)):this._triggered?this._schedule(t):(this._started=e,this._rescheduled=t)}_schedule(t){this._triggered=!1,this._started=he(),this._rescheduled=0,this._scheduled=t,this._timer=setTimeout(this._timerWrapper,t)}clear(){clearTimeout(this._timer)}};function Na(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var t=0;t<r.length;t++)r[t]=arguments[t+2]}return new lr(arguments[0],arguments[1],r)}Ni.exports=Na});var Ii=v((hh,Pi)=>{"use strict";var{AbortController:Fa}=globalThis,Oi=Fi(),Rt=class extends Fa{constructor(t){super(),this._ms=t,this._timer=Oi(()=>this.abort(),t),Object.setPrototypeOf(this,Rt.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=Oi(()=>this.abort(),this._ms)}};Pi.exports={TimeoutController:Rt}});var _e=v((Xh,gr)=>{"use strict";var Bt=typeof Reflect=="object"?Reflect:null,Gi=Bt&&typeof Bt.apply=="function"?Bt.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)},be;Bt&&typeof Bt.ownKeys=="function"?be=Bt.ownKeys:Object.getOwnPropertySymbols?be=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:be=function(t){return Object.getOwnPropertyNames(t)};function Xa(r){console&&console.warn&&console.warn(r)}var Qi=Number.isNaN||function(t){return t!==t};function k(){k.init.call(this)}gr.exports=k;gr.exports.once=Ya;k.EventEmitter=k;k.prototype._events=void 0;k.prototype._eventsCount=0;k.prototype._maxListeners=void 0;var ji=10;function we(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(k,"defaultMaxListeners",{enumerable:!0,get:function(){return ji},set:function(r){if(typeof r!="number"||r<0||Qi(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");ji=r}});k.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};k.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Qi(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Xi(r){return r._maxListeners===void 0?k.defaultMaxListeners:r._maxListeners}k.prototype.getMaxListeners=function(){return Xi(this)};k.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var i=t==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[t];if(c===void 0)return!1;if(typeof c=="function")Gi(c,this,e);else for(var u=c.length,l=ts(c,u),n=0;n<u;++n)Gi(l[n],this,e);return!0};function Ji(r,t,e,n){var i,s,o;if(we(e),s=r._events,s===void 0?(s=r._events=Object.create(null),r._eventsCount=0):(s.newListener!==void 0&&(r.emit("newListener",t,e.listener?e.listener:e),s=r._events),o=s[t]),o===void 0)o=s[t]=e,++r._eventsCount;else if(typeof o=="function"?o=s[t]=n?[e,o]:[o,e]:n?o.unshift(e):o.push(e),i=Xi(r),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=t,a.count=o.length,Xa(a)}return r}k.prototype.addListener=function(t,e){return Ji(this,t,e,!1)};k.prototype.on=k.prototype.addListener;k.prototype.prependListener=function(t,e){return Ji(this,t,e,!0)};function Ja(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ki(r,t,e){var n={fired:!1,wrapFn:void 0,target:r,type:t,listener:e},i=Ja.bind(n);return i.listener=e,n.wrapFn=i,i}k.prototype.once=function(t,e){return we(e),this.on(t,Ki(this,t,e)),this};k.prototype.prependOnceListener=function(t,e){return we(e),this.prependListener(t,Ki(this,t,e)),this};k.prototype.removeListener=function(t,e){var n,i,s,o,a;if(we(e),i=this._events,i===void 0)return this;if(n=i[t],n===void 0)return this;if(n===e||n.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||e));else if(typeof n!="function"){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===e||n[o].listener===e){a=n[o].listener,s=o;break}if(s<0)return this;s===0?n.shift():Ka(n,s),n.length===1&&(i[t]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",t,a||e)}return this};k.prototype.off=k.prototype.removeListener;k.prototype.removeAllListeners=function(t){var e,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[t]),this;if(arguments.length===0){var s=Object.keys(n),o;for(i=0;i<s.length;++i)o=s[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=n[t],typeof e=="function")this.removeListener(t,e);else if(e!==void 0)for(i=e.length-1;i>=0;i--)this.removeListener(t,e[i]);return this};function Zi(r,t,e){var n=r._events;if(n===void 0)return[];var i=n[t];return i===void 0?[]:typeof i=="function"?e?[i.listener||i]:[i]:e?Za(i):ts(i,i.length)}k.prototype.listeners=function(t){return Zi(this,t,!0)};k.prototype.rawListeners=function(t){return Zi(this,t,!1)};k.listenerCount=function(r,t){return typeof r.listenerCount=="function"?r.listenerCount(t):Yi.call(r,t)};k.prototype.listenerCount=Yi;function Yi(r){var t=this._events;if(t!==void 0){var e=t[r];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}k.prototype.eventNames=function(){return this._eventsCount>0?be(this._events):[]};function ts(r,t){for(var e=new Array(t),n=0;n<t;++n)e[n]=r[n];return e}function Ka(r,t){for(;t+1<r.length;t++)r[t]=r[t+1];r.pop()}function Za(r){for(var t=new Array(r.length),e=0;e<t.length;++e)t[e]=r[e].listener||r[e];return t}function Ya(r,t){return new Promise(function(e,n){function i(o){r.removeListener(t,s),n(o)}function s(){typeof r.removeListener=="function"&&r.removeListener("error",i),e([].slice.call(arguments))}es(r,t,s,{once:!0}),t!=="error"&&tc(r,i,{once:!0})})}function tc(r,t,e){typeof r.on=="function"&&es(r,"error",t,e)}function es(r,t,e,n){if(typeof r.on=="function")n.once?r.once(t,e):r.on(t,e);else if(typeof r.addEventListener=="function")r.addEventListener(t,function i(s){n.once&&r.removeEventListener(t,i),e(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var ds=v((hs,fs)=>{"use strict";var _c=Math.exp;hs=fs.exports=function(t){if(typeof t!="number")throw new Error("must provide a timespan to the moving average constructor");if(t<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let e,n=0,i=0,s=0,o,a={};function c(u,l){return 1-_c(-(u-l)/t)}return a.push=function(l,h){if(o){let f=c(l,o),m=h-e,d=f*m;e=f*h+(1-f)*e,n=(1-f)*(n+m*d),i=Math.sqrt(n),s=e+f*m}else e=h;o=l},a.movingAverage=function(){return e},a.variance=function(){return n},a.deviation=function(){return i},a.forecast=function(){return s},a}});var bs=v((Bf,Br)=>{function ys(r){let t=new globalThis.AbortController;function e(){t.abort();for(let n of r)!n||!n.removeEventListener||n.removeEventListener("abort",e)}for(let n of r)if(!(!n||!n.addEventListener)){if(n.aborted){e();break}n.addEventListener("abort",e)}return t.signal}Br.exports=ys;Br.exports.anySignal=ys});var Ac={};N(Ac,{createBitswap:()=>Cc});var As=Dr,Lr=128,Bs=127,Ts=~Bs,Ls=Math.pow(2,31);function Dr(r,t,e){t=t||[],e=e||0;for(var n=e;r>=Ls;)t[e++]=r&255|Lr,r/=128;for(;r&Ts;)t[e++]=r&255|Lr,r>>>=7;return t[e]=r|0,Dr.bytes=e-n+1,t}var Ms=Se,Ds=128,Mr=127;function Se(r,n){var e=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Se.bytes=0,new RangeError("Could not decode varint");o=r[s++],e+=i<28?(o&Mr)<<i:(o&Mr)*Math.pow(2,i),i+=7}while(o>=Ds);return Se.bytes=s-n,e}var Ns=Math.pow(2,7),Fs=Math.pow(2,14),Os=Math.pow(2,21),Ps=Math.pow(2,28),Is=Math.pow(2,35),zs=Math.pow(2,42),Rs=Math.pow(2,49),Us=Math.pow(2,56),Hs=Math.pow(2,63),qs=function(r){return r<Ns?1:r<Fs?2:r<Os?3:r<Ps?4:r<Is?5:r<zs?6:r<Rs?7:r<Us?8:r<Hs?9:10},Ws={encode:As,decode:Ms,encodingLength:qs},Vs=Ws,Tt=Vs;var Lt=(r,t=0)=>[Tt.decode(r,t),Tt.decode.bytes],yt=(r,t,e=0)=>(Tt.encode(r,t,e),t),bt=r=>Tt.encodingLength(r);var Mc=new Uint8Array(0);var Nr=(r,t)=>{if(r===t)return!0;if(r.byteLength!==t.byteLength)return!1;for(let e=0;e<r.byteLength;e++)if(r[e]!==t[e])return!1;return!0},J=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var Fr=r=>new TextEncoder().encode(r),Or=r=>new TextDecoder().decode(r);var st=(r,t)=>{let e=t.byteLength,n=bt(r),i=n+bt(e),s=new Uint8Array(i+e);return yt(r,s,0),yt(e,s,n),s.set(t,i),new wt(r,e,t,s)},Ir=r=>{let t=J(r),[e,n]=Lt(t),[i,s]=Lt(t.subarray(n)),o=t.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new wt(e,i,o,t)},zr=(r,t)=>{if(r===t)return!0;{let e=t;return r.code===e.code&&r.size===e.size&&e.bytes instanceof Uint8Array&&Nr(r.bytes,e.bytes)}},wt=class{constructor(t,e,n,i){this.code=t,this.size=e,this.digest=n,this.bytes=i}};var Te={};N(Te,{base58btc:()=>b,base58flickr:()=>Js});function $s(r,t){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),n=0;n<e.length;n++)e[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(e[o]!==255)throw new TypeError(s+" is ambiguous");e[o]=i}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function h(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,y=0,S=0,A=d.length;S!==A&&d[S]===0;)S++,p++;for(var P=(A-S)*l+1>>>0,T=new Uint8Array(P);S!==A;){for(var q=d[S],I=0,D=P-1;(q!==0||I<y)&&D!==-1;D--,I++)q+=256*T[D]>>>0,T[D]=q%a>>>0,q=q/a>>>0;if(q!==0)throw new Error("Non-zero carry");y=I,S++}for(var z=P-y;z!==P&&T[z]===0;)z++;for(var mt=c.repeat(p);z<P;++z)mt+=r.charAt(T[z]);return mt}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var y=0,S=0;d[p]===c;)y++,p++;for(var A=(d.length-p)*u+1>>>0,P=new Uint8Array(A);d[p];){var T=e[d.charCodeAt(p)];if(T===255)return;for(var q=0,I=A-1;(T!==0||q<S)&&I!==-1;I--,q++)T+=a*P[I]>>>0,P[I]=T%256>>>0,T=T/256>>>0;if(T!==0)throw new Error("Non-zero carry");S=q,p++}if(d[p]!==" "){for(var D=A-S;D!==A&&P[D]===0;)D++;for(var z=new Uint8Array(y+(A-D)),mt=y;D!==A;)z[mt++]=P[D++];return z}}}function m(d){var p=f(d);if(p)return p;throw new Error(`Non-${t} character`)}return{encode:h,decodeUnsafe:f,decode:m}}var Gs=$s,js=Gs,Rr=js;var Ee=class{constructor(t,e,n){this.name=t,this.prefix=e,this.baseEncode=n}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}},Ce=class{constructor(t,e,n){if(this.name=t,this.prefix=e,e.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=e.codePointAt(0),this.baseDecode=n}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return Ur(this,t)}},Ae=class{constructor(t){this.decoders=t}or(t){return Ur(this,t)}decode(t){let e=t[0],n=this.decoders[e];if(n)return n.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},Ur=(r,t)=>new Ae({...r.decoders||{[r.prefix]:r},...t.decoders||{[t.prefix]:t}}),Be=class{constructor(t,e,n,i){this.name=t,this.prefix=e,this.baseEncode=n,this.baseDecode=i,this.encoder=new Ee(t,e,n),this.decoder=new Ce(t,e,i)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}},_t=({name:r,prefix:t,encode:e,decode:n})=>new Be(r,t,e,n),Y=({prefix:r,name:t,alphabet:e})=>{let{encode:n,decode:i}=Rr(e,t);return _t({prefix:r,name:t,encode:n,decode:s=>J(i(s))})},Qs=(r,t,e,n)=>{let i={};for(let l=0;l<t.length;++l)i[t[l]]=l;let s=r.length;for(;r[s-1]==="=";)--s;let o=new Uint8Array(s*e/8|0),a=0,c=0,u=0;for(let l=0;l<s;++l){let h=i[r[l]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<e|h,a+=e,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=e||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Xs=(r,t,e)=>{let n=t[t.length-1]==="=",i=(1<<e)-1,s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>e;)o-=e,s+=t[i&a>>o];if(o&&(s+=t[i&a<<e-o]),n)for(;s.length*e&7;)s+="=";return s},E=({name:r,prefix:t,bitsPerChar:e,alphabet:n})=>_t({prefix:t,name:r,encode(i){return Xs(i,n,e)},decode(i){return Qs(i,n,e,r)}});var b=Y({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Js=Y({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Le={};N(Le,{base32:()=>tt,base32hex:()=>to,base32hexpad:()=>ro,base32hexpadupper:()=>no,base32hexupper:()=>eo,base32pad:()=>Zs,base32padupper:()=>Ys,base32upper:()=>Ks,base32z:()=>io});var tt=E({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Ks=E({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Zs=E({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ys=E({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),to=E({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),eo=E({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),ro=E({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),no=E({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),io=E({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Hr=(r,t)=>{let{bytes:e,version:n}=r;switch(n){case 0:return oo(e,Me(r),t||b.encoder);default:return ao(e,Me(r),t||tt.encoder)}};var qr=new WeakMap,Me=r=>{let t=qr.get(r);if(t==null){let e=new Map;return qr.set(r,e),e}return t},w=class{constructor(t,e,n,i){this.code=e,this.version=t,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:t,multihash:e}=this;if(t!==Dt)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(e.code!==co)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return w.createV0(e)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:t,digest:e}=this.multihash,n=st(t,e);return w.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return w.equals(this,t)}static equals(t,e){let n=e;return n&&t.code===n.code&&t.version===n.version&&zr(t.multihash,n.multihash)}toString(t){return Hr(this,t)}toJSON(){return{"/":Hr(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;let e=t;if(e instanceof w)return e;if(e["/"]!=null&&e["/"]===e.bytes||e.asCID===e){let{version:n,code:i,multihash:s,bytes:o}=e;return new w(n,i,s,o||Wr(n,i,s.bytes))}else if(e[uo]===!0){let{version:n,multihash:i,code:s}=e,o=Ir(i);return w.create(n,s,o)}else return null}static create(t,e,n){if(typeof e!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(e!==Dt)throw new Error(`Version 0 CID must use dag-pb (code: ${Dt}) block encoding`);return new w(t,e,n,n.bytes)}case 1:{let i=Wr(t,e,n.bytes);return new w(t,e,n,i)}default:throw new Error("Invalid version")}}static createV0(t){return w.create(0,Dt,t)}static createV1(t,e){return w.create(1,t,e)}static decode(t){let[e,n]=w.decodeFirst(t);if(n.length)throw new Error("Incorrect length");return e}static decodeFirst(t){let e=w.inspectBytes(t),n=e.size-e.multihashSize,i=J(t.subarray(n,n+e.multihashSize));if(i.byteLength!==e.multihashSize)throw new Error("Incorrect length");let s=i.subarray(e.multihashSize-e.digestSize),o=new wt(e.multihashCode,e.digestSize,s,i);return[e.version===0?w.createV0(o):w.createV1(e.codec,o),t.subarray(e.size)]}static inspectBytes(t){let e=0,n=()=>{let[h,f]=Lt(t.subarray(e));return e+=f,h},i=n(),s=Dt;if(i===18?(i=0,e=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);let o=e,a=n(),c=n(),u=e+c,l=u-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(t,e){let[n,i]=so(t,e),s=w.decode(i);if(s.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Me(s).set(n,t),s}},so=(r,t)=>{switch(r[0]){case"Q":{let e=t||b;return[b.prefix,e.decode(`${b.prefix}${r}`)]}case b.prefix:{let e=t||b;return[b.prefix,e.decode(r)]}case tt.prefix:{let e=t||tt;return[tt.prefix,e.decode(r)]}default:{if(t==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],t.decode(r)]}}},oo=(r,t,e)=>{let{prefix:n}=e;if(n!==b.prefix)throw Error(`Cannot string encode V0 in ${e.name} encoding`);let i=t.get(n);if(i==null){let s=e.encode(r).slice(1);return t.set(n,s),s}else return i},ao=(r,t,e)=>{let{prefix:n}=e,i=t.get(n);if(i==null){let s=e.encode(r);return t.set(n,s),s}else return i},Dt=112,co=18,Wr=(r,t,e)=>{let n=bt(r),i=n+bt(t),s=new Uint8Array(i+e.byteLength);return yt(r,s,0),yt(t,s,n),s.set(e,i),s},uo=Symbol.for("@ipld/js-cid/CID");var Fe={};N(Fe,{sha256:()=>Nt,sha512:()=>lo});var Ne=({name:r,code:t,encode:e})=>new De(r,t,e),De=class{constructor(t,e,n){this.name=t,this.code=e,this.encode=n}digest(t){if(t instanceof Uint8Array){let e=this.encode(t);return e instanceof Uint8Array?st(this.code,e):e.then(n=>st(this.code,n))}else throw Error("Unknown type, must be binary type")}};var $r=r=>async t=>new Uint8Array(await crypto.subtle.digest(r,t)),Nt=Ne({name:"sha2-256",code:18,encode:$r("SHA-256")}),lo=Ne({name:"sha2-512",code:19,encode:$r("SHA-512")});var pi=L(on(),1);var Ft=L(mn(),1);function zo(r){let t=new Uint8Array(r.reduce((n,i)=>n+Ft.default.encodingLength(i),0)),e=0;for(let n of r)t=Ft.encode(n,t,e),e+=Ft.default.encodingLength(n);return t}var yn=zo;var R=L(xn(),1);var Re={};N(Re,{base64:()=>ze,base64pad:()=>Ko,base64url:()=>Zo,base64urlpad:()=>Yo});var ze=E({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Ko=E({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Zo=E({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Yo=E({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});R.default.formatters.b=r=>r==null?"undefined":b.baseEncode(r);R.default.formatters.t=r=>r==null?"undefined":tt.baseEncode(r);R.default.formatters.m=r=>r==null?"undefined":ze.baseEncode(r);R.default.formatters.p=r=>r==null?"undefined":r.toString();R.default.formatters.c=r=>r==null?"undefined":r.toString();R.default.formatters.k=r=>r==null?"undefined":r.toString();function ta(r){let t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=r,t.destroy=()=>!0,t.extend=()=>t,t}function kn(r){let t=ta(`${r}:trace`);return R.default.enabled(`${r}:trace`)&&R.default.names.map(e=>e.toString()).find(e=>e.includes(":trace"))!=null&&(t=(0,R.default)(`${r}:trace`)),Object.assign((0,R.default)(r),{error:(0,R.default)(`${r}:error`),trace:t})}function jt(r,t){if(r===t)return!0;if(r.byteLength!==t.byteLength)return!1;for(let e=0;e<r.byteLength;e++)if(r[e]!==t[e])return!1;return!0}var at=class{constructor(t,e,n){this._refCounter=1,this.cid=t,this.priority=e??1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(b)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(t){return this._refCounter===t._refCounter&&this.cid.equals(t.cid)&&this.priority===t.priority&&this.wantType===t.wantType}};var et=class{constructor(t,e,n,i,s){this.entry=new at(t,e,n),this.cancel=!!i,this.sendDontHave=!!s}get cid(){return this.entry.cid}set cid(t){this.entry.cid=t}get priority(){return this.entry.priority}set priority(t){this.entry.priority=t}get wantType(){return this.entry.wantType}set wantType(t){this.entry.wantType=t}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(b)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(t){return this.cancel===t.cancel&&this.sendDontHave===t.sendDontHave&&this.wantType===t.wantType&&this.entry.equals(t.entry)}};var U=(r,t)=>{let e=["bitswap"];return t!=null&&e.push(t),r!=null&&e.push(`${r.toString().slice(0,8)}`),kn(e.join(":"))};var Qt=(r,t)=>{if(r.size!==t.size)return!1;for(let[e,n]of r){let i=t.get(e);if(i===void 0||n instanceof Uint8Array&&i instanceof Uint8Array&&!jt(n,i)||n instanceof et&&i instanceof et&&!n.equals(i))return!1}return!0};var Ze=L(Ve(),1),li=L(ri(),1),hi=L(ut(),1),Ye=L(Ke(),1),fi=L(ui(),1);function ua(){hi.default._configure(),Ze.default._configure(li.default),Ye.default._configure(fi.default)}ua();var di=["uint64","int64","sint64","fixed64","sfixed64"];function la(r){for(let t of di){if(r[t]==null)continue;let e=r[t];r[t]=function(){return BigInt(e.call(this).toString())}}return r}function tr(r){return la(new Ze.default(r))}function ha(r){for(let t of di){if(r[t]==null)continue;let e=r[t];r[t]=function(n){return e.call(this,n.toString())}}return r}function er(){return ha(Ye.default.create())}function ht(r,t){let e=tr(r instanceof Uint8Array?r:r.subarray());return t.decode(e)}function ft(r,t){let e=er();return t.encode(r,e,{lengthDelimited:!1}),e.finish()}var Et;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Et||(Et={}));function Yt(r,t,e,n){return{name:r,type:t,encode:e,decode:n}}function te(r){function t(i){if(r[i.toString()]==null)throw new Error("Invalid enum value");return r[i]}let e=function(s,o){let a=t(s);o.int32(a)},n=function(s){let o=s.int32();return t(o)};return Yt("enum",Et.VARINT,e,n)}function dt(r,t){return Yt("message",Et.LENGTH_DELIMITED,r,t)}var M;(function(r){let t;(function(a){let c;(function(f){f.Block="Block",f.Have="Have"})(c=a.WantType||(a.WantType={}));let u;(function(f){f[f.Block=0]="Block",f[f.Have=1]="Have"})(u||(u={})),function(f){f.codec=()=>te(u)}(c=a.WantType||(a.WantType={}));let l;(function(f){let m;f.codec=()=>(m==null&&(m=dt((d,p,y={})=>{y.lengthDelimited!==!1&&p.fork(),d.block!=null&&d.block.byteLength>0&&(p.uint32(10),p.bytes(d.block)),d.priority!=null&&d.priority!==0&&(p.uint32(16),p.int32(d.priority)),d.cancel!=null&&d.cancel!==!1&&(p.uint32(24),p.bool(d.cancel)),d.wantType!=null&&u[d.wantType]!==0&&(p.uint32(32),r.Wantlist.WantType.codec().encode(d.wantType,p)),d.sendDontHave!=null&&d.sendDontHave!==!1&&(p.uint32(40),p.bool(d.sendDontHave)),y.lengthDelimited!==!1&&p.ldelim()},(d,p)=>{let y={block:new Uint8Array(0),priority:0,cancel:!1,wantType:c.Block,sendDontHave:!1},S=p==null?d.len:d.pos+p;for(;d.pos<S;){let A=d.uint32();switch(A>>>3){case 1:y.block=d.bytes();break;case 2:y.priority=d.int32();break;case 3:y.cancel=d.bool();break;case 4:y.wantType=r.Wantlist.WantType.codec().decode(d);break;case 5:y.sendDontHave=d.bool();break;default:d.skipType(A&7);break}}return y})),m),f.encode=d=>ft(d,f.codec()),f.decode=d=>ht(d,f.codec())})(l=a.Entry||(a.Entry={}));let h;a.codec=()=>(h==null&&(h=dt((f,m,d={})=>{if(d.lengthDelimited!==!1&&m.fork(),f.entries!=null)for(let p of f.entries)m.uint32(10),r.Wantlist.Entry.codec().encode(p,m);f.full!=null&&f.full!==!1&&(m.uint32(16),m.bool(f.full)),d.lengthDelimited!==!1&&m.ldelim()},(f,m)=>{let d={entries:[],full:!1},p=m==null?f.len:f.pos+m;for(;f.pos<p;){let y=f.uint32();switch(y>>>3){case 1:d.entries.push(r.Wantlist.Entry.codec().decode(f,f.uint32()));break;case 2:d.full=f.bool();break;default:f.skipType(y&7);break}}return d})),h),a.encode=f=>ft(f,a.codec()),a.decode=f=>ht(f,a.codec())})(t=r.Wantlist||(r.Wantlist={}));let e;(function(a){let c;a.codec=()=>(c==null&&(c=dt((u,l,h={})=>{h.lengthDelimited!==!1&&l.fork(),u.prefix!=null&&u.prefix.byteLength>0&&(l.uint32(10),l.bytes(u.prefix)),u.data!=null&&u.data.byteLength>0&&(l.uint32(18),l.bytes(u.data)),h.lengthDelimited!==!1&&l.ldelim()},(u,l)=>{let h={prefix:new Uint8Array(0),data:new Uint8Array(0)},f=l==null?u.len:u.pos+l;for(;u.pos<f;){let m=u.uint32();switch(m>>>3){case 1:h.prefix=u.bytes();break;case 2:h.data=u.bytes();break;default:u.skipType(m&7);break}}return h})),c),a.encode=u=>ft(u,a.codec()),a.decode=u=>ht(u,a.codec())})(e=r.Block||(r.Block={}));let n;(function(a){a.Have="Have",a.DontHave="DontHave"})(n=r.BlockPresenceType||(r.BlockPresenceType={}));let i;(function(a){a[a.Have=0]="Have",a[a.DontHave=1]="DontHave"})(i||(i={})),function(a){a.codec=()=>te(i)}(n=r.BlockPresenceType||(r.BlockPresenceType={}));let s;(function(a){let c;a.codec=()=>(c==null&&(c=dt((u,l,h={})=>{h.lengthDelimited!==!1&&l.fork(),u.cid!=null&&u.cid.byteLength>0&&(l.uint32(10),l.bytes(u.cid)),u.type!=null&&i[u.type]!==0&&(l.uint32(16),r.BlockPresenceType.codec().encode(u.type,l)),h.lengthDelimited!==!1&&l.ldelim()},(u,l)=>{let h={cid:new Uint8Array(0),type:n.Have},f=l==null?u.len:u.pos+l;for(;u.pos<f;){let m=u.uint32();switch(m>>>3){case 1:h.cid=u.bytes();break;case 2:h.type=r.BlockPresenceType.codec().decode(u);break;default:u.skipType(m&7);break}}return h})),c),a.encode=u=>ft(u,a.codec()),a.decode=u=>ht(u,a.codec())})(s=r.BlockPresence||(r.BlockPresence={}));let o;r.codec=()=>(o==null&&(o=dt((a,c,u={})=>{if(u.lengthDelimited!==!1&&c.fork(),a.wantlist!=null&&(c.uint32(10),r.Wantlist.codec().encode(a.wantlist,c)),a.blocks!=null)for(let l of a.blocks)c.uint32(18),c.bytes(l);if(a.payload!=null)for(let l of a.payload)c.uint32(26),r.Block.codec().encode(l,c);if(a.blockPresences!=null)for(let l of a.blockPresences)c.uint32(34),r.BlockPresence.codec().encode(l,c);a.pendingBytes!=null&&a.pendingBytes!==0&&(c.uint32(40),c.int32(a.pendingBytes)),u.lengthDelimited!==!1&&c.ldelim()},(a,c)=>{let u={blocks:[],payload:[],blockPresences:[],pendingBytes:0},l=c==null?a.len:a.pos+c;for(;a.pos<l;){let h=a.uint32();switch(h>>>3){case 1:u.wantlist=r.Wantlist.codec().decode(a,a.uint32());break;case 2:u.blocks.push(a.bytes());break;case 3:u.payload.push(r.Block.codec().decode(a,a.uint32()));break;case 4:u.blockPresences.push(r.BlockPresence.codec().decode(a,a.uint32()));break;case 5:u.pendingBytes=a.int32();break;default:a.skipType(h&7);break}}return u})),o),r.encode=a=>ft(a,r.codec()),r.decode=a=>ht(a,r.codec())})(M||(M={}));var ee=class extends Error{constructor(t,e,n){super(t),this.code=e,this.name=n?.name??"CodeError",this.props=n??{}}};var fa,x=class{constructor(t){this.full=t,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return this.blocks.size===0&&this.wantlist.size===0&&this.blockPresences.size===0}addEntry(t,e,n,i,s){n==null&&(n=x.WantType.Block);let o=t.toString(b),a=this.wantlist.get(o);a!=null?(a.wantType===n&&(a.priority=e),i===!0&&(a.cancel=!!i),s===!0&&(a.sendDontHave=!!s),n===x.WantType.Block&&a.wantType===x.WantType.Have&&(a.wantType=n)):this.wantlist.set(o,new et(t,e,n,i,s))}addBlock(t,e){let n=t.toString(b);this.blocks.set(n,e)}addHave(t){let e=t.toString(b);this.blockPresences.has(e)||this.blockPresences.set(e,x.BlockPresenceType.Have)}addDontHave(t){let e=t.toString(b);this.blockPresences.has(e)||this.blockPresences.set(e,x.BlockPresenceType.DontHave)}cancel(t){let e=t.toString(b);this.wantlist.delete(e),this.addEntry(t,0,x.WantType.Block,!0,!1)}setPendingBytes(t){this.pendingBytes=t}serializeToBitswap100(){return M.encode({wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),cancel:!!t.cancel,wantType:M.Wantlist.WantType.Block,sendDontHave:!1})),full:!!this.full},blocks:Array.from(this.blocks.values())})}serializeToBitswap110(){let t={wantlist:{entries:Array.from(this.wantlist.values()).map(e=>({block:e.cid.bytes,priority:Number(e.priority),wantType:e.wantType,cancel:!!e.cancel,sendDontHave:!!e.sendDontHave})),full:!!this.full},blockPresences:[],payload:[],pendingBytes:this.pendingBytes,blocks:[]};for(let[e,n]of this.blocks.entries()){let i=w.parse(e),s=i.version,o=i.code,a=i.multihash.code,c=i.multihash.digest.length,u=yn([s,o,a,c]);t.payload.push({prefix:u,data:n})}for(let[e,n]of this.blockPresences)t.blockPresences.push({cid:w.parse(e).bytes,type:n});return this.pendingBytes>0&&(t.pendingBytes=this.pendingBytes),M.encode(t)}equals(t){return!(this.full!==t.full||this.pendingBytes!==t.pendingBytes||!Qt(this.wantlist,t.wantlist)||!Qt(this.blocks,t.blocks)||!Qt(this.blockPresences,t.blockPresences))}get[Symbol.toStringTag](){let t=Array.from(this.wantlist.keys()),e=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${t}, blocks: ${e}>`}};fa=x;x.Entry=et;x.WantType={Block:M.Wantlist.WantType.Block,Have:M.Wantlist.WantType.Have};x.BlockPresenceType={Have:M.BlockPresenceType.Have,DontHave:M.BlockPresenceType.DontHave};x.deserialize=async(r,t)=>{let e=M.decode(r),n=e.wantlist?.full===!0,i=new x(n);return e.wantlist?.entries.forEach(s=>{if(s.block==null)return;let o=w.decode(s.block);i.addEntry(o,s.priority??0,s.wantType,!!s.cancel,!!s.sendDontHave)}),e.blockPresences.forEach(s=>{if(s.cid==null)return;let o=w.decode(s.cid);s.type===x.BlockPresenceType.Have?i.addHave(o):i.addDontHave(o)}),e.blocks.length>0?(await Promise.all(e.blocks.map(async s=>{let o=await Nt.digest(s),a=w.createV0(o);i.addBlock(a,s)})),i):(e.payload.length>0&&(await Promise.all(e.payload.map(async s=>{if(s.prefix==null||s.data==null)return;let o=(0,pi.default)(s.prefix),a=o[0],c=o[1],u=o[2],l=u===Nt.code?Nt:await t?.getHasher(u);if(l==null)throw new ee("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");let h=await l.digest(s.data),f=w.create(a,c,h);i.addBlock(f,s.data)})),i.setPendingBytes(e.pendingBytes)),i)};x.blockPresenceSize=r=>r.bytes.length+1;var rr=class extends Map{constructor(t){super();let{name:e,metrics:n}=t;this.metric=n.registerMetric(e),this.updateComponentMetric()}set(t,e){return super.set(t,e),this.updateComponentMetric(),this}delete(t){let e=super.delete(t);return this.updateComponentMetric(),e}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function it(r){let{name:t,metrics:e}=r,n;return e!=null?n=new rr({name:t,metrics:e}):n=new Map,n}var gi={Block:M.Wantlist.WantType.Block,Have:M.Wantlist.WantType.Have},da=(r,t)=>Array.prototype.slice.call(t,0).sort((e,n)=>{let i=r(e),s=r(n);return i<s?-1:i>s?1:0}),K=class{constructor(t,e){this.set=e!=null?it({name:"ipfs_bitswap_wantlist",metrics:e.metrics}):new Map,this._stats=t}get length(){return this.set.size}add(t,e,n){let i=t.toString(b),s=this.set.get(i);s!=null?(s.inc(),s.priority=e,s.wantType===gi.Have&&n===gi.Block&&(s.wantType=n)):(this.set.set(i,new at(t,e,n)),this._stats!=null&&this._stats.push(void 0,"wantListSize",1))}remove(t){let e=t.toString(b),n=this.set.get(e);n!=null&&(n.dec(),!n.hasRefs()&&(this.set.delete(e),this._stats!=null&&this._stats.push(void 0,"wantListSize",-1)))}removeForce(t){this.set.has(t)&&this.set.delete(t)}forEach(t){this.set.forEach(t)}entries(){return this.set.entries()}sortedEntries(){return new Map(da(t=>t[1].key,Array.from(this.set.entries())))}contains(t){let e=t.toString(b);return this.set.has(e)}get(t){let e=t.toString(b);return this.set.get(e)}};K.Entry=at;var mi=Math.pow(2,31)-1,yi=1e3,bi=1;var wi=pa;function pa(r,t,e){var n=null,i=null,s=function(){n&&(clearTimeout(n),i=null,n=null)},o=function(){var c=i;s(),c&&c()},a=function(){if(!t)return r.apply(this,arguments);var c=this,u=arguments,l=e&&!n;if(s(),i=function(){r.apply(c,u)},n=setTimeout(function(){if(n=null,!l){var h=i;return i=null,h()}},t),l)return i()};return a.cancel=s,a.flush=o,a}var re=class{constructor(t,e,n){this.peerId=e,this.network=n,this.refcnt=1,this._entries=[],this._log=U(t,"msgqueue"),this.sendEntries=wi(this.sendEntries.bind(this),bi)}addMessage(t,e={}){t.empty||this.send(t,e)}addEntries(t,e={}){this._entries=this._entries.concat(t),this.sendEntries(e)}sendEntries(t={}){if(this._entries.length===0)return;let e=new x(!1);this._entries.forEach(n=>{n.cancel===!0?e.cancel(n.cid):e.addEntry(n.cid,n.priority)}),this._entries=[],this.addMessage(e,t)}async send(t,e={}){try{await this.network.connectTo(this.peerId,e)}catch(n){this._log.error("cant connect to peer %p: %s",this.peerId,n.message);return}this._log("sending message to peer %p",this.peerId),this.network.sendMessage(this.peerId,t,e).catch(n=>{this._log.error("send error",n)})}};var ne=class{constructor(t,e,n,i){this.peers=it({name:"ipfs_bitswap_want_manager_peers",metrics:i.metrics}),this.wantlist=new K(n,i),this.network=e,this._peerId=t,this._log=U(t,"want")}_addEntries(t,e,n,i={}){let s=t.map((o,a)=>new x.Entry(o,mi-a,x.WantType.Block,e));s.forEach(o=>{o.cancel?n===!0?this.wantlist.removeForce(o.cid.toString(b)):this.wantlist.remove(o.cid):(this._log("adding to wantlist"),this.wantlist.add(o.cid,o.priority))});for(let o of this.peers.values())o.addEntries(s,i)}_startPeerHandler(t){let e=this.peers.get(t.toString());if(e!=null){e.refcnt++;return}e=new re(this._peerId,t,this.network);let n=new x(!0);for(let i of this.wantlist.entries())n.addEntry(i[1].cid,i[1].priority);return e.addMessage(n),this.peers.set(t.toString(),e),e}_stopPeerHandler(t){let e=this.peers.get(t.toString());e!=null&&(e.refcnt--,!(e.refcnt>0)&&this.peers.delete(t.toString()))}wantBlocks(t,e={}){this._addEntries(t,!1,!1,e),e.signal?.addEventListener("abort",()=>{this.cancelWants(t)})}unwantBlocks(t){this._log("unwant blocks: %s",t.length),this._addEntries(t,!0,!0)}cancelWants(t){this._log("cancel wants: %s",t.length),this._addEntries(t,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(t){this._startPeerHandler(t)}disconnected(t){this._stopPeerHandler(t)}start(){}stop(){this.peers.forEach(t=>{this.disconnected(t.peerId)})}};function It(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function Z(r=0){return globalThis.Buffer?.alloc!=null?It(globalThis.Buffer.alloc(r)):new Uint8Array(r)}function $(r=0){return globalThis.Buffer?.allocUnsafe!=null?It(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function ir(r,t){t==null&&(t=r.reduce((i,s)=>i+s.length,0));let e=$(t),n=0;for(let i of r)e.set(i,n),n+=i.length;return It(e)}var vi=Symbol.for("@achingbrain/uint8arraylist");function _i(r,t){if(t==null||t<0)throw new RangeError("index is out of bounds");let e=0;for(let n of r){let i=e+n.byteLength;if(t<i)return{buf:n,index:t-e};e=i}throw new RangeError("index is out of bounds")}function ie(r){return!!r?.[vi]}var X=class{constructor(...t){Object.defineProperty(this,vi,{value:!0}),this.bufs=[],this.length=0,t.length>0&&this.appendAll(t)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...t){this.appendAll(t)}appendAll(t){let e=0;for(let n of t)if(n instanceof Uint8Array)e+=n.byteLength,this.bufs.push(n);else if(ie(n))e+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}prepend(...t){this.prependAll(t)}prependAll(t){let e=0;for(let n of t.reverse())if(n instanceof Uint8Array)e+=n.byteLength,this.bufs.unshift(n);else if(ie(n))e+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}get(t){let e=_i(this.bufs,t);return e.buf[e.index]}set(t,e){let n=_i(this.bufs,t);n.buf[n.index]=e}write(t,e=0){if(t instanceof Uint8Array)for(let n=0;n<t.length;n++)this.set(e+n,t[n]);else if(ie(t))for(let n=0;n<t.length;n++)this.set(e+n,t.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(t){if(t=Math.trunc(t),!(Number.isNaN(t)||t<=0)){if(t===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(t>=this.bufs[0].byteLength)t-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(t),this.length-=t;break}}}slice(t,e){let{bufs:n,length:i}=this._subList(t,e);return ir(n,i)}subarray(t,e){let{bufs:n,length:i}=this._subList(t,e);return n.length===1?n[0]:ir(n,i)}sublist(t,e){let{bufs:n,length:i}=this._subList(t,e),s=new X;return s.length=i,s.bufs=n,s}_subList(t,e){if(t=t??0,e=e??this.length,t<0&&(t=this.length+t),e<0&&(e=this.length+e),t<0||e>this.length)throw new RangeError("index is out of bounds");if(t===e)return{bufs:[],length:0};if(t===0&&e===this.length)return{bufs:[...this.bufs],length:this.length};let n=[],i=0;for(let s=0;s<this.bufs.length;s++){let o=this.bufs[s],a=i,c=a+o.byteLength;if(i=c,t>=c)continue;let u=t>=a&&t<c,l=e>a&&e<=c;if(u&&l){if(t===a&&e===c){n.push(o);break}let h=t-a;n.push(o.subarray(h,h+(e-t)));break}if(u){if(t===0){n.push(o);continue}n.push(o.subarray(t-a));continue}if(l){if(e===c){n.push(o);break}n.push(o.subarray(0,e-a));break}n.push(o)}return{bufs:n,length:e-t}}indexOf(t,e=0){if(!ie(t)&&!(t instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=t instanceof Uint8Array?t:t.subarray();if(e=Number(e??0),isNaN(e)&&(e=0),e<0&&(e=this.length+e),e<0&&(e=0),t.length===0)return e>this.length?this.length:e;let i=n.byteLength;if(i===0)throw new TypeError("search must be at least 1 byte long");let s=256,o=new Int32Array(s);for(let h=0;h<s;h++)o[h]=-1;for(let h=0;h<i;h++)o[n[h]]=h;let a=o,c=this.byteLength-n.byteLength,u=n.byteLength-1,l;for(let h=e;h<=c;h+=l){l=0;for(let f=u;f>=0;f--){let m=this.get(h+f);if(n[f]!==m){l=Math.max(1,f-a[m]);break}}if(l===0)return h}return-1}getInt8(t){let e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getInt8(0)}setInt8(t,e){let n=$(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,e),this.write(n,t)}getInt16(t,e){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,e)}setInt16(t,e,n){let i=Z(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt16(0,e,n),this.write(i,t)}getInt32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,e)}setInt32(t,e,n){let i=Z(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt32(0,e,n),this.write(i,t)}getBigInt64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,e)}setBigInt64(t,e,n){let i=Z(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigInt64(0,e,n),this.write(i,t)}getUint8(t){let e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getUint8(0)}setUint8(t,e){let n=$(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,e),this.write(n,t)}getUint16(t,e){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,e)}setUint16(t,e,n){let i=Z(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint16(0,e,n),this.write(i,t)}getUint32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,e)}setUint32(t,e,n){let i=Z(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,e,n),this.write(i,t)}getBigUint64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,e)}setBigUint64(t,e,n){let i=Z(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigUint64(0,e,n),this.write(i,t)}getFloat32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,e)}setFloat32(t,e,n){let i=Z(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat32(0,e,n),this.write(i,t)}getFloat64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,e)}setFloat64(t,e,n){let i=Z(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat64(0,e,n),this.write(i,t)}equals(t){if(t==null||!(t instanceof X)||t.bufs.length!==this.bufs.length)return!1;for(let e=0;e<this.bufs.length;e++)if(!jt(this.bufs[e],t.bufs[e]))return!1;return!0}static fromUint8Arrays(t,e){let n=new X;return n.bufs=t,e==null&&(e=t.reduce((i,s)=>i+s.byteLength,0)),n.length=e,n}};function se(r){return r instanceof Uint8Array?{get(t){return r[t]},set(t,e){r[t]=e}}:{get(t){return r.get(t)},set(t,e){r.set(t,e)}}}var xi=4294967296,O=class{constructor(t=0,e=0){this.hi=t,this.lo=e}toBigInt(t){if(t===!0)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let e=~this.lo+1>>>0,n=~this.hi>>>0;return e===0&&(n=n+1>>>0),-(BigInt(e)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toNumber(t){return Number(this.toBigInt(t))}zzDecode(){let t=-(this.lo&1),e=((this.lo>>>1|this.hi<<31)^t)>>>0,n=(this.hi>>>1^t)>>>0;return new O(n,e)}zzEncode(){let t=this.hi>>31,e=((this.hi<<1|this.lo>>>31)^t)>>>0,n=(this.lo<<1^t)>>>0;return new O(e,n)}toBytes(t,e=0){let n=se(t);for(;this.hi>0;)n.set(e++,this.lo&127|128),this.lo=(this.lo>>>7|this.hi<<25)>>>0,this.hi>>>=7;for(;this.lo>127;)n.set(e++,this.lo&127|128),this.lo=this.lo>>>7;n.set(e++,this.lo)}static fromBigInt(t){if(t===0n)return new O;let e=t<0;e&&(t=-t);let n=Number(t>>32n)|0,i=Number(t-(BigInt(n)<<32n))|0;return e&&(n=~n>>>0,i=~i>>>0,++i>xi&&(i=0,++n>xi&&(n=0))),new O(n,i)}static fromNumber(t){if(t===0)return new O;let e=t<0;e&&(t=-t);let n=t>>>0,i=(t-n)/4294967296>>>0;return e&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new O(i,n)}static fromBytes(t,e=0){let n=se(t),i=new O,s=0;if(t.length-e>4){for(;s<4;++s)if(i.lo=(i.lo|(n.get(e)&127)<<s*7)>>>0,n.get(e++)<128)return i;if(i.lo=(i.lo|(n.get(e)&127)<<28)>>>0,i.hi=(i.hi|(n.get(e)&127)>>4)>>>0,n.get(e++)<128)return i;s=0}else for(;s<4;++s){if(e>=t.length)throw RangeError(`index out of range: ${e} > ${t.length}`);if(i.lo=(i.lo|(n.get(e)&127)<<s*7)>>>0,n.get(e++)<128)return i}if(t.length-e>4){for(;s<5;++s)if(i.hi=(i.hi|(n.get(e)&127)<<s*7+3)>>>0,n.get(e++)<128)return i}else if(e<t.byteLength)for(;s<5;++s){if(e>=t.length)throw RangeError(`index out of range: ${e} > ${t.length}`);if(i.hi=(i.hi|(n.get(e)&127)<<s*7+3)>>>0,n.get(e++)<128)return i}throw RangeError("invalid varint encoding")}};var ga=Math.pow(2,7),ma=Math.pow(2,14),ya=Math.pow(2,21),ba=Math.pow(2,28),wa=Math.pow(2,35),_a=Math.pow(2,42),va=Math.pow(2,49),xa=Math.pow(2,56),ka=Math.pow(2,63),pt={encodingLength(r){return r<ga?1:r<ma?2:r<ya?3:r<ba?4:r<wa?5:r<_a?6:r<va?7:r<xa?8:r<ka?9:10},encode(r,t,e=0){if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return t==null&&(t=$(pt.encodingLength(r))),O.fromNumber(r).toBytes(t,e),t},decode(r,t=0){return O.fromBytes(r,t).toNumber(!0)}};function oe(r){return r[Symbol.asyncIterator]!=null}var ae=r=>{let t=pt.encodingLength(r),e=$(t);return pt.encode(r,e),ae.bytes=t,e};ae.bytes=0;function ce(r,t){t=t??{};let e=t.lengthEncoder??ae;function*n(i){let s=e(i.byteLength);s instanceof Uint8Array?yield s:yield*s,i instanceof Uint8Array?yield i:yield*i}return oe(r)?async function*(){for await(let i of r)yield*n(i)}():function*(){for(let i of r)yield*n(i)}()}ce.single=(r,t)=>{t=t??{};let e=t.lengthEncoder??ae;return new X(e(r.byteLength),r)};var Ct=L(Ei(),1);var Ea=8,Ca=1024*1024*4,gt;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(gt||(gt={}));var sr=r=>{let t=pt.decode(r);return sr.bytes=pt.encodingLength(t),t};sr.bytes=0;function zt(r,t){let e=new X,n=gt.LENGTH,i=-1,s=t?.lengthDecoder??sr,o=t?.maxLengthLength??Ea,a=t?.maxDataLength??Ca;function*c(){for(;e.byteLength>0;){if(n===gt.LENGTH)try{if(i=s(e),i<0)throw(0,Ct.default)(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>a)throw(0,Ct.default)(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");let u=s.bytes;e.consume(u),t?.onLength!=null&&t.onLength(i),n=gt.DATA}catch(u){if(u instanceof RangeError){if(e.byteLength>o)throw(0,Ct.default)(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw u}if(n===gt.DATA){if(e.byteLength<i)break;let u=e.sublist(0,i);e.consume(i),t?.onData!=null&&t.onData(u),yield u,n=gt.LENGTH}}}return oe(r)?async function*(){for await(let u of r)e.append(u),yield*c();if(e.byteLength>0)throw(0,Ct.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(let u of r)e.append(u),yield*c();if(e.byteLength>0)throw(0,Ct.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}zt.fromReader=(r,t)=>{let e=1,n=async function*(){for(;;)try{let{done:s,value:o}=await r.next(e);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{e=1}}();return zt(n,{...t??{},onLength:s=>{e=s}})};var ue=class{constructor(t){if(!(t>0)||t-1&t)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){let t=this.buffer[this.btm];if(t!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return this.buffer[this.btm]===void 0}},At=class{constructor(t={}){this.hwm=t.splitLimit??16,this.head=new ue(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return t?.byteLength!=null?t.byteLength:1}push(t){if(t?.value!=null&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){let e=this.head;this.head=e.next=new ue(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(t===void 0&&this.tail.next!=null){let e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return t?.value!=null&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}};function le(r={}){return Ba(e=>{let n=e.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function Ba(r,t){t=t??{};let e=t.onEnd,n=new At,i,s,o,a=async()=>n.isEmpty()?o?{done:!0}:await new Promise((p,y)=>{s=S=>{s=null,n.push(S);try{p(r(n))}catch(A){y(A)}return i}}):r(n),c=p=>s!=null?s(p):(n.push(p),i),u=p=>(n=new At,s!=null?s({error:p}):(n.push({error:p}),i)),l=p=>{if(o)return i;if(t?.objectMode!==!0&&p?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return c({done:!1,value:p})},h=p=>o?i:(o=!0,p!=null?u(p):c({done:!0})),f=()=>(n=new At,h(),{done:!0}),m=p=>(h(p),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:a,return:f,throw:m,push:l,end:h,get readableLength(){return n.size}},e==null)return i;let d=i;return i={[Symbol.asyncIterator](){return this},next(){return d.next()},throw(p){return d.throw(p),e!=null&&(e(p),e=void 0),{done:!0}},return(){return d.return(),e!=null&&(e(),e=void 0),{done:!0}},push:l,end(p){return d.end(p),e!=null&&(e(p),e=void 0),i},get readableLength(){return d.readableLength}},i}function Ta(r){return r[Symbol.asyncIterator]!=null}function La(...r){let t=[];for(let e of r)Ta(e)||t.push(e);return t.length===r.length?function*(){for(let e of t)yield*e}():async function*(){let e=le({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async n=>{for await(let i of n)e.push(i)})),e.end()}catch(n){e.end(n)}}),yield*e}()}var Ci=La;function ar(r,...t){if(r==null)throw new Error("Empty pipeline");if(or(r)){let n=r;r=()=>n.source}else if(Bi(r)||Ai(r)){let n=r;r=()=>n}let e=[r,...t];if(e.length>1&&or(e[e.length-1])&&(e[e.length-1]=e[e.length-1].sink),e.length>2)for(let n=1;n<e.length-1;n++)or(e[n])&&(e[n]=Da(e[n]));return Ma(...e)}var Ma=(...r)=>{let t;for(;r.length>0;)t=r.shift()(t);return t},Ai=r=>r?.[Symbol.asyncIterator]!=null,Bi=r=>r?.[Symbol.iterator]!=null,or=r=>r==null?!1:r.sink!=null&&r.source!=null,Da=r=>t=>{let e=r.sink(t);if(e?.then!=null){let n=le({objectMode:!0});e.then(()=>{n.end()},o=>{n.end(o)});let i,s=r.source;if(Ai(s))i=async function*(){yield*s,n.end()};else if(Bi(s))i=function*(){yield*s,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Ci(n,i())}return r.source};var cr=Symbol.for("@libp2p/topology");var Ti=()=>{},ur=class{constructor(t){this.min=t.min??0,this.max=t.max??1/0,this.peers=new Set,this.onConnect=t.onConnect??Ti,this.onDisconnect=t.onDisconnect??Ti}get[Symbol.toStringTag](){return cr.toString()}get[cr](){return!0}async setRegistrar(t){this.registrar=t}disconnect(t){this.onDisconnect(t)}};function Li(r){return new ur(r)}var Wi=L(Ii(),1);var Ut=class extends Error{constructor(t,e){super(t??"The operation was aborted"),this.type="aborted",this.code=e??"ABORT_ERR"}};function zi(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function Ri(r,t,e){let n=e??{},i=zi(r);async function*s(){let o,a=()=>{o?.()};for(t.addEventListener("abort",a);;){let c;try{if(t.aborted){let{abortMessage:l,abortCode:h}=n;throw new Ut(l,h)}let u=new Promise((l,h)=>{o=()=>{let{abortMessage:f,abortCode:m}=n;h(new Ut(f,m))}});c=await Promise.race([u,i.next()]),o=null}catch(u){t.removeEventListener("abort",a);let l=u.type==="aborted"&&t.aborted;if(l&&n.onAbort!=null&&await n.onAbort(r),typeof i.return=="function")try{let h=i.return();h instanceof Promise&&h.catch(f=>{n.onReturnError!=null&&n.onReturnError(f)})}catch(h){n.onReturnError!=null&&n.onReturnError(h)}if(l&&n.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}t.removeEventListener("abort",a)}return s()}var G=class extends Event{constructor(t,e){super(t),this.detail=e}};function Oa(r){return r[Symbol.asyncIterator]!=null}function Pa(r,t){return Oa(r)?async function*(){let e=0;if(!(t<1)){for await(let n of r)if(yield n,e++,e===t)return}}():function*(){let e=0;if(!(t<1)){for(let n of r)if(yield n,e++,e===t)return}}()}var Ui=Pa;function Ia(r){return r[Symbol.asyncIterator]!=null}function za(r){if(Ia(r))return(async()=>{for await(let t of r);})();for(let t of r);}var Hi=za;function Ra(r){let[t,e]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>t.next(),push:i=>{n.push(i)},next:()=>n.length>0?{done:!1,value:n.shift()}:t.next(),[e](){return this}}}var fe=Ra;function Ua(r){return r[Symbol.asyncIterator]!=null}function Ha(r,t){if(Ua(r))return async function*(){for await(let a of r)yield t(a)}();let e=fe(r),{value:n,done:i}=e.next();if(i===!0)return function*(){}();let s=t(n);if(typeof s.then=="function")return async function*(){yield await s;for await(let a of e)yield t(a)}();let o=t;return function*(){yield s;for(let a of e)yield o(a)}()}var qi=Ha;var hr="/ipfs/bitswap/1.0.0",fr="/ipfs/bitswap/1.1.0",dr="/ipfs/bitswap/1.2.0",Wa=1024,Va=1024,$a=3e4,de=class{constructor(t,e,n,i={}){this._log=U(t.peerId,"network"),this._libp2p=t,this._bitswap=e,this._protocols=[hr],i.b100Only!==!0&&(this._protocols.unshift(fr),this._protocols.unshift(dr)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=i.hashLoader??{async getHasher(){throw new Error("Not implemented")}},this._maxInboundStreams=i.maxInboundStreams??Wa,this._maxOutboundStreams=i.maxOutboundStreams??Va,this._incomingStreamTimeout=i.incomingStreamTimeout??$a}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});let t=Li({onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect});this._registrarIds=[];for(let e of this._protocols)this._registrarIds.push(await this._libp2p.register(e,t));this._libp2p.getConnections().forEach(e=>{this._onPeerConnect(e.remotePeer)})}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),this._registrarIds!=null){for(let t of this._registrarIds)this._libp2p.unregister(t);this._registrarIds=[]}}_onConnection(t){if(!this._running)return;let{stream:e,connection:n}=t,i=new Wi.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then(async()=>{this._log("incoming new bitswap %s connection from %p",e.stat.protocol,n.remotePeer),await ar(Ri(e.source,i.signal),s=>zt(s),async s=>{for await(let o of s){try{let a=await x.deserialize(o.subarray(),this._hashLoader);await this._bitswap._receiveMessage(n.remotePeer,a)}catch(a){this._bitswap._receiveError(a);break}i.reset()}})}).catch(s=>{this._log(s),e.abort(s)}).finally(()=>{i.clear(),e.close()})}_onPeerConnect(t){this._bitswap._onPeerConnected(t)}_onPeerDisconnect(t){this._bitswap._onPeerDisconnected(t)}findProviders(t,e={}){return e.onProgress?.(new G("bitswap:network:find-providers",t)),this._libp2p.contentRouting.findProviders(t,e)}async findAndConnect(t,e){await Hi(Ui(qi(this.findProviders(t,e),async n=>await this.connectTo(n.id,e).catch(i=>{this._log.error(i)})),3)).catch(n=>{this._log.error(n)})}async provide(t,e={}){e.onProgress?.(new G("bitswap:network:provide",t)),await this._libp2p.contentRouting.provide(t,e)}async sendMessage(t,e,n={}){if(!this._running)throw new Error("network isn't running");let i=t.toString();this._log("sendMessage to %s",i,e),n.onProgress?.(new G("bitswap:network:send-wantlist",t)),await this._writeMessage(t,e,n),this._updateSentStats(t,e.blocks)}async connectTo(t,e={}){if(!this._running)throw new Error("network isn't running");return e.onProgress?.(new G("bitswap:network:dial",t)),await this._libp2p.dial(t,e)}_updateSentStats(t,e){let n=t.toString();if(this._stats!=null){for(let i of e.values())this._stats.push(n,"dataSent",i.length);this._stats.push(n,"blocksSent",e.size)}}async _writeMessage(t,e,n={}){let i=await this._libp2p.dialProtocol(t,[dr,fr,hr]);try{let s;switch(i.stat.protocol){case hr:s=e.serializeToBitswap100();break;case fr:case dr:s=e.serializeToBitswap110();break;default:throw new Error(`Unknown protocol: ${i.stat.protocol}`)}await ar([s],o=>ce(o),i)}catch(s){n.onProgress?.(new G("bitswap:network:send-wantlist:error",{peer:t,error:s})),this._log(s)}finally{i.close()}}};var pe=class{constructor(t){this.partner=t,this.wantlist=new K,this.exchangeCount=0,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(t){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesSent+=t}receivedBytes(t){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesRecv+=t}wants(t,e,n){this.wantlist.add(t,e,n)}cancelWant(t){this.wantlist.remove(t)}wantlistContains(t){return this.wantlist.get(t)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}};var Ht=class extends Map{constructor(t,e){super(),this._cmp=e??this._defaultSort,this._keys=[];for(let[n,i]of t??[])this.set(n,i)}update(t){if(t<0||t>=this._keys.length)return;let e=this._keys[t];this._keys.splice(t,1);let n=this._find(e);this._keys.splice(n,0,e)}set(t,e){if(this.has(t)){let i=this.indexOf(t);this._keys.splice(i,1)}super.set(t,e);let n=this._find(t);return this._keys.splice(n,0,t),this}clear(){super.clear(),this._keys=[]}delete(t){if(!this.has(t))return!1;let e=this.indexOf(t);return this._keys.splice(e,1),super.delete(t)}indexOf(t){if(!this.has(t))return-1;let e=this._find(t);if(this._keys[e]===t)return e;for(let n=1;n<this._keys.length;n++){if(this._keys[e+n]===t)return e+n;if(this._keys[e-n]===t)return e-n}return-1}_find(t){let e=0,n=this._keys.length;for(;e<n;){let i=e+n>>>1,s=this._kCmp(this._keys[i],t);if(s<0)e=i+1;else if(s>0)n=i;else return i}return e}*keys(){for(let t of this._keys)yield t}*values(){for(let t of this._keys)yield this.get(t)}*entries(){for(let t of this._keys)yield[t,this.get(t)]}*[Symbol.iterator](){yield*this.entries()}forEach(t,e=this){if(t!=null)for(let n of this._keys){let i=this.get(n);if(i==null)throw new Error("Value cannot be undefined");t.apply(e,[[n,i]])}}_defaultSort(t,e){return t[0]<e[0]?-1:e[0]<t[0]?1:0}_kCmp(t,e){return this._cmp([t,this.get(t)],[e,this.get(e)])}};var Ga={hasNewInfo(){return!1},merge(){}},ge=class{constructor(t=Ga){this._taskMerger=t,this._byPeer=new Ht([],me.compare)}pushTasks(t,e){let n=this._byPeer.get(t.toString());n==null&&(n=new me(t,this._taskMerger)),n.pushTasks(e),this._byPeer.set(t.toString(),n)}popTasks(t){let e=this._head();if(e===void 0)return{tasks:[],pendingSize:0};let{tasks:n,pendingSize:i}=e.popTasks(t);if(n.length===0)return{tasks:n,pendingSize:i};let s=e.peerId;return e.isIdle()?this._byPeer.delete(s.toString()):this._byPeer.update(0),{peerId:s,tasks:n,pendingSize:i}}_head(){if(this._byPeer.size!==0)for(let[,t]of this._byPeer)return t}remove(t,e){this._byPeer.get(e.toString())?.remove(t)}tasksDone(t,e){let n=this._byPeer.get(t.toString());if(n==null)return;let i=this._byPeer.indexOf(t.toString());for(let s of e)n.taskDone(s);this._byPeer.update(i)}},me=class{constructor(t,e){this.peerId=t,this._taskMerger=e,this._activeTotalSize=0,this._pending=new pr,this._active=new Set}pushTasks(t){for(let e of t)this._pushTask(e)}_pushTask(t){if(!this._taskHasMoreInfoThanActiveTasks(t))return;let e=this._pending.get(t.topic);if(e!=null){t.priority>e.priority&&this._pending.updatePriority(t.topic,t.priority),this._taskMerger.merge(t,e);return}this._pending.add(t)}_taskHasMoreInfoThanActiveTasks(t){let e=[];for(let n of this._active)n.topic===t.topic&&e.push(n);return e.length===0?!0:this._taskMerger.hasNewInfo(t,e)}popTasks(t){let e=0,n=[],i=this._pending.tasks();for(let s=0;s<i.length&&e<t;s++){let o=i[s];n.push(o),e+=o.size,this._pending.delete(o.topic),this._activeTotalSize+=o.size,this._active.add(o)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(t){this._active.has(t)&&(this._activeTotalSize-=t.size,this._active.delete(t))}remove(t){this._pending.delete(t)}isIdle(){return this._pending.length===0&&this._active.size===0}static compare(t,e){return t[1]._pending.length===0?1:e[1]._pending.length===0?-1:t[1]._activeTotalSize===e[1]._activeTotalSize?e[1]._pending.length-t[1]._pending.length:t[1]._activeTotalSize-e[1]._activeTotalSize}},pr=class{constructor(){this._tasks=new Ht([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce((t,e)=>t+e.task.size,0)}get(t){return this._tasks?.get(t)?.task}add(t){this._tasks.set(t.topic,{created:Date.now(),task:t})}delete(t){this._tasks.delete(t)}tasks(){return[...this._tasks.values()].map(t=>t.task)}updatePriority(t,e){let n=this._tasks.get(t);if(n==null)return;let i=this._tasks.indexOf(t);n.task.priority=e,this._tasks.update(i)}_compare(t,e){return t[1].task.priority===e[1].task.priority?t[1].created-e[1].created:e[1].task.priority-t[1].task.priority}};var Vi={hasNewInfo(r,t){let e=!1,n=!1;for(let i of t)i.data.haveBlock&&(e=!0),i.data.isWantBlock&&(n=!0);return!!(!n&&r.data.isWantBlock||!e&&r.data.haveBlock)},merge(r,t){let e=r.data,n=t.data;!n.haveBlock&&e.haveBlock&&(n.haveBlock=e.haveBlock,n.blockSize=e.blockSize),!n.isWantBlock&&e.isWantBlock&&(n.isWantBlock=!0,(!n.haveBlock||e.haveBlock)&&(n.haveBlock=e.haveBlock,t.size=r.size)),n.isWantBlock&&n.haveBlock&&(t.size=n.blockSize)}};var $i=x.WantType,ja=16*1024,Qa=1024,ye=class{constructor(t,e,n,i,s,o={}){this._log=U(t,"engine"),this.blockstore=e,this.network=n,this._stats=i,this._opts=this._processOpts(o),this.ledgerMap=it({name:"ipfs_bitswap_ledger_map",metrics:s.metrics}),this._running=!1,this._requestQueue=new ge(Vi)}_processOpts(t){return{maxSizeReplaceHasWithBlock:Qa,targetMessageSize:ja,...t}}_scheduleProcessTasks(){setTimeout(()=>{this._processTasks().catch(t=>{this._log.error("error processing stats",t)})})}async _processTasks(){if(!this._running)return;let{peerId:t,tasks:e,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(e.length===0)return;let i=new x(!1);i.setPendingBytes(n);let s=[],o=new Map;for(let c of e){let u=w.parse(c.topic);c.data.haveBlock?c.data.isWantBlock?(s.push(u),o.set(c.topic,c.data)):i.addHave(u):i.addDontHave(u)}let a=await this._getBlocks(s);for(let[c,u]of o){let l=w.parse(c),h=a.get(c);h!=null?i.addBlock(l,h):u.sendDontHave&&i.addDontHave(l)}if(i.empty){t!=null&&this._requestQueue.tasksDone(t,e),this._scheduleProcessTasks();return}try{t!=null&&await this.network.sendMessage(t,i);for(let[c,u]of a.entries())t!=null&&this.messageSent(t,w.parse(c),u)}catch(c){this._log.error(c)}t!=null&&this._requestQueue.tasksDone(t,e),this._scheduleProcessTasks()}wantlistForPeer(t){let e=t.toString(),n=this.ledgerMap.get(e);return n!=null?n.wantlist.sortedEntries():new Map}ledgerForPeer(t){let e=t.toString(),n=this.ledgerMap.get(e);if(n!=null)return{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}}peers(){return Array.from(this.ledgerMap.values()).map(t=>t.partner)}receivedBlocks(t){if(t.length!==0){for(let e of this.ledgerMap.values())for(let{cid:n,block:i}of t){let s=e.wantlistContains(n);if(s==null)continue;let o=i.length,a=this._sendAsBlock(s.wantType,o),c=o;a||(c=x.blockPresenceSize(s.cid)),this._requestQueue.pushTasks(e.partner,[{topic:s.cid.toString(b),priority:s.priority,size:c,data:{blockSize:o,isWantBlock:a,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(t,e){let n=this._findOrCreate(t);if(e.empty)return;if(e.full&&(n.wantlist=new K),this._updateBlockAccounting(e.blocks,n),e.wantlist.size===0){this._scheduleProcessTasks();return}let i=[],s=[];e.wantlist.forEach(o=>{o.cancel?(n.cancelWant(o.cid),i.push(o.cid)):(n.wants(o.cid,o.priority,o.wantType),s.push(o))}),this._cancelWants(t,i),await this._addWants(t,s),this._scheduleProcessTasks()}_cancelWants(t,e){for(let n of e)this._requestQueue.remove(n.toString(b),t)}async _addWants(t,e){let n=await this._getBlockSizes(e.map(s=>s.cid)),i=[];for(let s of e){let o=s.cid.toString(b),a=n.get(o);if(a==null)s.sendDontHave&&i.push({topic:o,priority:s.priority,size:x.blockPresenceSize(s.cid),data:{isWantBlock:s.wantType===$i.Block,blockSize:0,haveBlock:!1,sendDontHave:s.sendDontHave}});else{let c=this._sendAsBlock(s.wantType,a),u=a;c||(u=x.blockPresenceSize(s.cid)),i.push({topic:o,priority:s.priority,size:u,data:{isWantBlock:c,blockSize:a,haveBlock:!0,sendDontHave:s.sendDontHave}})}this._requestQueue.pushTasks(t,i)}}_sendAsBlock(t,e){return t===$i.Block||e<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(t){let e=await this._getBlocks(t);return new Map([...e].map(([n,i])=>[n,i.length]))}async _getBlocks(t){let e=new Map;return await Promise.all(t.map(async n=>{try{let i=await this.blockstore.get(n);e.set(n.toString(b),i)}catch(i){i.code!=="ERR_NOT_FOUND"&&this._log.error("failed to query blockstore for %s: %s",n,i)}})),e}_updateBlockAccounting(t,e){for(let n of t.values())this._log("got block (%s bytes)",n.length),e.receivedBytes(n.length)}messageSent(t,e,n){let i=this._findOrCreate(t);i.sentBytes(n.length),i.wantlist.remove(e)}numBytesSentTo(t){return this._findOrCreate(t).accounting.bytesSent}numBytesReceivedFrom(t){return this._findOrCreate(t).accounting.bytesRecv}peerDisconnected(t){this.ledgerMap.delete(t.toString())}_findOrCreate(t){let e=t.toString(),n=this.ledgerMap.get(e);if(n!=null)return n;let i=new pe(t);return this.ledgerMap.set(e,i),this._stats!=null&&this._stats.push(e,"peerCount",1),i}start(){this._running=!0}stop(){this._running=!1}};var ls=L(_e(),1);var mr={};N(mr,{identity:()=>ec});var ec=_t({prefix:"\0",name:"identity",encode:r=>Or(r),decode:r=>Fr(r)});var yr={};N(yr,{base2:()=>rc});var rc=E({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var br={};N(br,{base8:()=>nc});var nc=E({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var wr={};N(wr,{base10:()=>ic});var ic=Y({prefix:"9",name:"base10",alphabet:"0123456789"});var _r={};N(_r,{base16:()=>sc,base16upper:()=>oc});var sc=E({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),oc=E({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var vr={};N(vr,{base36:()=>ac,base36upper:()=>cc});var ac=Y({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),cc=Y({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var xr={};N(xr,{base256emoji:()=>dc});var rs=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),uc=rs.reduce((r,t,e)=>(r[e]=t,r),[]),lc=rs.reduce((r,t,e)=>(r[t.codePointAt(0)]=e,r),[]);function hc(r){return r.reduce((t,e)=>(t+=uc[e],t),"")}function fc(r){let t=[];for(let e of r){let n=lc[e.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${e}`);t.push(n)}return new Uint8Array(t)}var dc=_t({prefix:"\u{1F680}",name:"base256emoji",encode:hc,decode:fc});var kr={};N(kr,{identity:()=>mc});var ns=0,pc="identity",is=J,gc=r=>st(ns,is(r)),mc={code:ns,name:pc,encode:is,digest:gc};var af=new TextEncoder,cf=new TextDecoder;var Sr={...mr,...yr,...br,...wr,..._r,...Le,...vr,...Te,...Re,...xr},df={...Fe,...kr};function os(r,t,e,n){return{name:r,prefix:t,encoder:{name:r,prefix:t,encode:e},decoder:{decode:n}}}var ss=os("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Er=os("ascii","a",r=>{let t="a";for(let e=0;e<r.length;e++)t+=String.fromCharCode(r[e]);return t},r=>{r=r.substring(1);let t=$(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}),wc={utf8:ss,"utf-8":ss,hex:Sr.base16,latin1:Er,ascii:Er,binary:Er,...Sr},as=wc;function Cr(r,t="utf8"){let e=as[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return(t==="utf8"||t==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):e.encoder.encode(r).substring(1)}var cs=r=>`unwant:${Cr(r.multihash.bytes,"base64")}`,us=r=>`block:${Cr(r.multihash.bytes,"base64")}`,ve=class extends ls.EventEmitter{constructor(t){super(),this.setMaxListeners(yi),this._log=U(t,"notif")}hasBlock(t,e){let n=us(t);this._log(n),this.emit(n,e)}async wantBlock(t,e={}){if(t==null)throw new Error("Not a valid cid");let n=us(t),i=cs(t);return this._log(`wantBlock:${t}`),await new Promise((s,o)=>{let a=()=>{this.removeListener(n,c),e.onProgress?.(new G("bitswap:want-block:unwant",t)),o(new Error(`Block for ${t} unwanted`))},c=u=>{this.removeListener(i,a),e.onProgress?.(new G("bitswap:want-block:block",t)),s(u)};this.once(i,a),this.once(n,c),e.signal?.addEventListener("abort",()=>{this.removeListener(n,c),this.removeListener(i,a),o(new Error(`Want for ${t} aborted`))})})}unwantBlock(t){let e=cs(t);this._log(e),this.emit(e)}};var ms=L(_e(),1);var ps=L(_e(),1),Ar=L(ds(),1),qt=class extends ps.EventEmitter{constructor(t,e){super(),this._options=e,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),t.forEach(n=>{this._stats[n]=BigInt(0),this._movingAverages[n]={},this._options.movingAverageIntervals.forEach(i=>{(this._movingAverages[n][i]=(0,Ar.default)(i)).push(this._frequencyLastTime,0)})}),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._enabled=!1}stop(){this._timeout!=null&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(t,e){this._enabled&&(this._queue.push([t,e,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout!=null&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){let t=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-t),0)}_update(){if(this._timeout=void 0,this._queue.length>0){let t;for(;this._queue.length>0;){let e=t=this._queue.shift();e!=null&&this._applyOp(e)}t!=null&&this._updateFrequency(t[2]),this.emit("update",this._stats)}}_updateFrequency(t){let e=t-this._frequencyLastTime;e>0&&Object.keys(this._stats).forEach(n=>{this._updateFrequencyFor(n,e,t)}),this._frequencyLastTime=t}_updateFrequencyFor(t,e,n){let i=this._frequencyAccumulators[t]??0;this._frequencyAccumulators[t]=0;let s=i/e*1e3,o=this._movingAverages[t];o==null&&(o=this._movingAverages[t]={}),this._options.movingAverageIntervals.forEach(a=>{let c=o[a];c==null&&(c=o[a]=(0,Ar.default)(a)),c.push(n,s)})}_applyOp(t){let e=t[0],n=t[1];if(typeof n!="number")throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,e)||(this._stats[e]=BigInt(0)),this._stats[e]=BigInt(this._stats[e])+BigInt(n),this._frequencyAccumulators[e]==null&&(this._frequencyAccumulators[e]=0),this._frequencyAccumulators[e]+=n}};var gs={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3]},xe=class extends ms.EventEmitter{constructor(t,e=[],n=gs){super();let i=Object.assign({},gs,n);if(typeof i.computeThrottleTimeout!="number")throw new Error("need computeThrottleTimeout");if(typeof i.computeThrottleMaxQueueSize!="number")throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=e,this._options=i,this._enabled=this._options.enabled,this._global=new qt(e,i),this._global.on("update",s=>this.emit("update",s)),this._peers=it({name:"ipfs_bitswap_stats_peers",metrics:t.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(let t of this._peers)t[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(t){let e=t.toString();return this._peers.get(e)}push(t,e,n){if(this._enabled&&(this._global.push(e,n),t!=null)){let i=this._peers.get(t);i==null&&(i=new qt(this._initialCounters,this._options),this._peers.set(t,i)),i.push(e,n)}}disconnected(t){let e=t.toString(),n=this._peers.get(e);n!=null&&(n.stop(),this._peers.delete(e))}};var _s=L(bs(),1);function vc(r){return r[Symbol.asyncIterator]!=null}function xc(r,t){if(vc(r))return async function*(){for await(let a of r)await t(a),yield a}();let e=fe(r),{value:n,done:i}=e.next();if(i===!0)return function*(){}();if(typeof t(n)?.then=="function")return async function*(){yield n;for await(let a of e)await t(a),yield a}();let o=t;return function*(){yield n;for(let a of e)o(a),yield a}()}var ws=xc;var kc={async getHasher(){throw new Error("Not implemented")}},Sc={maxInboundStreams:1024,maxOutboundStreams:1024,incomingStreamTimeout:3e4,hashLoader:kc,statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},Ec=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"],ke=class{constructor(t,e,n={}){this._libp2p=t,this._log=U(this.peerId),n=Object.assign({},Sc,n),this.stats=new xe(t,Ec,{enabled:n.statsEnabled,computeThrottleTimeout:n.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:n.statsComputeThrottleMaxQueueSize}),this.network=new de(t,this,this.stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=e,this.engine=new ye(this.peerId,e,this.network,this.stats,t),this.wm=new ne(this.peerId,this.network,this.stats,t),this.notifications=new ve(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(t,e){try{await this.engine.messageReceived(t,e)}catch{this._log("failed to receive message",e)}if(e.blocks.size===0)return;let n=[];for(let[i,s]of e.blocks.entries()){let o=w.parse(i);n.push({wasWanted:this.wm.wantlist.contains(o),cid:o,data:s})}this.wm.cancelWants(n.filter(({wasWanted:i})=>i).map(({cid:i})=>i)),await Promise.all(n.map(async({cid:i,wasWanted:s,data:o})=>{await this._handleReceivedBlock(t,i,o,s)}))}async _handleReceivedBlock(t,e,n,i){this._log("received block");let s=await this.blockstore.has(e);this._updateReceiveCounters(t.toString(),e,n,s),i&&await this.put(e,n)}_updateReceiveCounters(t,e,n,i){this.stats.push(t,"blocksReceived",1),this.stats.push(t,"dataReceived",n.length),i&&(this.stats.push(t,"dupBlksReceived",1),this.stats.push(t,"dupDataReceived",n.length))}_receiveError(t){this._log.error("ReceiveError",t)}_onPeerConnected(t){this.wm.connected(t)}_onPeerDisconnected(t){this.wm.disconnected(t),this.engine.peerDisconnected(t),this.stats.disconnected(t)}enableStats(){this.stats.enable()}disableStats(){this.stats.disable()}wantlistForPeer(t,e){return this.engine.wantlistForPeer(t)}ledgerForPeer(t){return this.engine.ledgerForPeer(t)}async want(t,e={}){let n=async(c,u)=>(this.wm.wantBlocks([c],u),await this.notifications.wantBlock(c,u)),i=!1,s=async(c,u)=>{try{return await this.blockstore.get(c,u)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l;return i||(i=!0,this.network.findAndConnect(c,u).catch(h=>{this._log.error(h)})),await n(c,u)}},o=new AbortController,a=e.signal!=null?(0,_s.anySignal)([e.signal,o.signal]):o.signal;try{return await Promise.race([this.notifications.wantBlock(t,{...e,signal:a}),s(t,{...e,signal:a})])}finally{o.abort()}}unwant(t){let e=Array.isArray(t)?t:[t];this.wm.unwantBlocks(e),e.forEach(n=>{this.notifications.unwantBlock(n)})}cancelWants(t){this.wm.cancelWants(Array.isArray(t)?t:[t])}async put(t,e,n){await this.blockstore.put(t,e),this.notify(t,e)}async*putMany(t,e){yield*this.blockstore.putMany(ws(t,({cid:n,block:i})=>{this.notify(n,i)}),e)}notify(t,e,n={}){this.notifications.hasBlock(t,e),this.engine.receivedBlocks([{cid:t,block:e}]),this.network.provide(t,n).catch(i=>{this._log.error("Failed to provide: %s",i.message)})}getWantlist(){return this.wm.wantlist.entries()}get peers(){return this.engine.peers()}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this.stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}};var Cc=(r,t,e={})=>new ke(r,t,e);return Cs(Ac);})();
return IpfsBitswap}));
